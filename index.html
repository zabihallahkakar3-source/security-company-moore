<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø±Ú©Øª Ù…Ø­Ø§ÙØ¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }

        * {
            box-sizing: border-box;
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„ ØµÙØ­Ù‡ Ù„Ø§Ú¯ÛŒÙ† */
        .auth-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 450px;
            padding: 40px 30px;
            position: relative;
            overflow: hidden;
        }

        .auth-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-logo {
            width: 80px;
            height: 80px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 2rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .form-control {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .btn-auth {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
        }

        .btn-auth:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .main-system {
            display: none;
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø³ÛŒØ³ØªÙ… */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        .navbar-brand {
            font-weight: 700;
        }

        .user-badge {
            background: var(--success-color);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-right: 10px;
        }

        .section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            display: none;
        }

        #guards {
            display: block;
        }

        .guard-item, .shift-item, .incident-item, .leave-item {
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .guard-item:hover, .shift-item:hover, .incident-item:hover, .leave-item:hover {
            background: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .badge {
            font-size: 0.75em;
            margin: 2px;
        }

        .profile-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--secondary-color);
        }

        .list-group-item {
            border: none;
            padding: 15px 20px;
            font-weight: 600;
            border-radius: 10px !important;
            margin-bottom: 5px;
            transition: all 0.3s ease;
        }

        .list-group-item:hover {
            background: #e9ecef;
        }

        .list-group-item.active {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            border-color: var(--secondary-color);
        }

        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            display: none;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .shift-badge {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .day-shift {
            background-color: #ffc107;
            color: #000;
        }

        .night-shift {
            background-color: #343a40;
            color: #fff;
        }

        .day-night-shift {
            background-color: #0dcaf0;
            color: #000;
        }

        .severity-low { background-color: #198754; color: white; }
        .severity-medium { background-color: #ffc107; color: #000; }
        .severity-high { background-color: #fd7e14; color: white; }
        .severity-critical { background-color: #dc3545; color: white; }
        .status-pending { background-color: #6c757d; color: white; }
        .status-approved { background-color: #198754; color: white; }
        .status-rejected { background-color: #dc3545; color: white; }
        .status-reported { background-color: #0dcaf0; color: #000; }

        .role-admin { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .role-manager { background: linear-gradient(135deg, #3498db, #2980b9); }
        .role-guard { background: linear-gradient(135deg, #27ae60, #229954); }

        .chart-bar {
            background: #0d6efd;
            height: 20px;
            margin: 5px 0;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .activity-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .auth-card {
                padding: 30px 20px;
                margin: 10px;
            }
            
            .section {
                padding: 20px;
            }
            
            .guard-item, .shift-item, .incident-item, .leave-item {
                padding: 15px;
            }
        }

        @media (max-width: 576px) {
            .auth-card {
                padding: 25px 15px;
            }
            
            .section {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Ù†Ø´Ø§Ù†Ú¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± -->
    <div class="auto-save-indicator" id="saveIndicator">
        <i class="fas fa-check-circle"></i> Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯
    </div>

    <!-- Ø³ÛŒØ³ØªÙ… Ù„Ø§Ú¯ÛŒÙ† -->
    <div id="loginSystem" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h3>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</h3>
                <p class="text-muted">Ù„Ø·ÙØ§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</label>
                    <input type="text" class="form-control" id="loginPhone" required value="0780060833">
                </div>
                <div class="form-group">
                    <label class="form-label">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                    <input type="password" class="form-control" id="loginPassword" required value="admin123">
                </div>
                <button type="submit" class="btn btn-auth mb-3">
                    <i class="fas fa-sign-in-alt"></i> ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…
                </button>
                
                <div class="alert alert-info">
                    <small>
                        <i class="fas fa-info-circle"></i> 
                        <strong>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾ÛŒØ´ÙØ±Ø¶ Ø§Ø¯Ù…ÛŒÙ†:</strong><br>
                        Ø´Ù…Ø§Ø±Ù‡: 0780060833 | Ø±Ù…Ø²: admin123
                    </small>
                </div>
            </form>
        </div>
    </div>

    <!-- Ø³ÛŒØ³ØªÙ… Ø§ØµÙ„ÛŒ -->
    <div id="mainSystem" class="main-system">
        <!-- Ù†ÙˆØ§Ø± Ø¨Ø§Ù„Ø§ÛŒÛŒ -->
        <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1">
                    <i class="fas fa-shield-alt"></i> Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø±Ú©Øª Ù…Ø­Ø§ÙØ¸
                    <small class="fs-6 d-block">
                        <span id="userWelcome">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</span>
                        <span id="userBadge" class="user-badge"></span>
                    </small>
                </span>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <div class="navbar-nav ms-auto d-flex align-items-center">
                        <button class="btn btn-outline-light btn-sm" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container-fluid mt-4">
            <div class="row">
                <!-- Ù…Ù†ÙˆÛŒ Ú©Ù†Ø§Ø±ÛŒ -->
                <div class="col-md-3 col-12 mb-4">
                    <div class="list-group">
                        <a href="#guards" class="list-group-item list-group-item-action active" onclick="showSection('guards')">
                            <i class="fas fa-users"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø­Ø§ÙØ¸Ø§Ù†
                        </a>
                        <a href="#shifts" class="list-group-item list-group-item-action" onclick="showSection('shifts')">
                            <i class="fas fa-calendar-alt"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ø´ÛŒÙØªâ€ŒÙ‡Ø§
                        </a>
                        <a href="#incidents" class="list-group-item list-group-item-action" onclick="showSection('incidents')">
                            <i class="fas fa-exclamation-triangle"></i> Ú¯Ø²Ø§Ø±Ø´ Ø­ÙˆØ§Ø¯Ø«
                        </a>
                        <a href="#leaves" class="list-group-item list-group-item-action" onclick="showSection('leaves')">
                            <i class="fas fa-umbrella-beach"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø±Ø®ØµÛŒ
                        </a>
                        <a href="#reports" class="list-group-item list-group-item-action" onclick="showSection('reports')">
                            <i class="fas fa-chart-bar"></i> Ú¯Ø²Ø§Ø±Ø´Ø§Øª
                        </a>
                    </div>
                </div>

                <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ -->
                <div class="col-md-9 col-12">
                    <!-- Ø¨Ø®Ø´ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø­Ø§ÙØ¸Ø§Ù† -->
                    <div id="guards" class="section">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4><i class="fas fa-users"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø­Ø§ÙØ¸Ø§Ù†</h4>
                            <button id="addGuardBtn" class="btn btn-success" onclick="showAddGuardForm()">
                                <i class="fas fa-user-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­Ø§ÙØ¸
                            </button>
                        </div>

                        <!-- ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­Ø§ÙØ¸ -->
                        <div id="addGuardForm" class="card mb-4" style="display: none;">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Ø«Ø¨Øª Ù…Ø­Ø§ÙØ¸ Ø¬Ø¯ÛŒØ¯</h5>
                            </div>
                            <div class="card-body">
                                <form id="guardForm" class="row g-3">
                                    <div class="col-md-4 col-12">
                                        <label class="form-label">Ù†Ø§Ù…</label>
                                        <input type="text" class="form-control" id="firstName" required>
                                    </div>
                                    <div class="col-md-4 col-12">
                                        <label class="form-label">ØªØ®Ù„Øµ</label>
                                        <input type="text" class="form-control" id="lastName" required>
                                    </div>
                                    <div class="col-md-4 col-12">
                                        <label class="form-label">Ù†Ø§Ù… Ù¾Ø¯Ø±</label>
                                        <input type="text" class="form-control" id="fatherName" required>
                                    </div>
                                    
                                    <div class="col-md-6 col-12">
                                        <label class="form-label">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</label>
                                        <input type="text" class="form-control" id="phoneNumber" required>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <label class="form-label">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                                        <input type="password" class="form-control" id="guardPassword" required>
                                    </div>

                                    <div class="col-md-6 col-12">
                                        <label class="form-label">Ø±ØªØ¨Ù‡</label>
                                        <select class="form-select" id="position" required>
                                            <option value="Guard">Ú«Ø§Ø±Ø¯ - Guard</option>
                                            <option value="Officer">Ø§ÙØ³Ø± - Officer</option>
                                            <option value="Second_Lieutenant">Ø³Ø§ØªÙ†Ù…Ù† - Second Lieutenant</option>
                                            <option value="First_Lieutenant">Ù„ÙˆÙ…Ú“ÛŒ Ø³Ø§ØªÙ†Ù…Ù† - First Lieutenant</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <label class="form-label">Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø±</label>
                                        <select class="form-select" id="userRole" required>
                                            <option value="guard">Ù…Ø­Ø§ÙØ¸</option>
                                            <option value="manager">Ù…Ø¯ÛŒØ±</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6 col-12">
                                        <label class="form-label">ØªØ§Ø±ÛŒØ® Ø§Ø³ØªØ®Ø¯Ø§Ù…</label>
                                        <input type="date" class="form-control" id="hireDate" required>
                                    </div>
                                    <div class="col-md-6 col-12">
                                        <label class="form-label">Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                                        <input type="file" class="form-control" id="profilePhoto" accept="image/*">
                                    </div>
                                    
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-success me-2">
                                            <i class="fas fa-save"></i> Ø«Ø¨Øª Ù…Ø­Ø§ÙØ¸
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="hideAddGuardForm()">
                                            <i class="fas fa-times"></i> Ù„ØºÙˆ
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <h5><i class="fas fa-list"></i> Ù„ÛŒØ³Øª Ù…Ø­Ø§ÙØ¸Ø§Ù†</h5>
                        <div id="guardsList" class="mt-3"></div>
                    </div>

                    <!-- Ø¨Ø®Ø´ Ù…Ø¯ÛŒØ±ÛŒØª Ø´ÛŒÙØªâ€ŒÙ‡Ø§ -->
                    <div id="shifts" class="section">
                        <h4><i class="fas fa-calendar-plus"></i> Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø´ÛŒÙØª Ø¬Ø¯ÛŒØ¯</h4>
                        <form id="shiftForm" class="row g-3">
                            <div class="col-md-6 col-12">
                                <label class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø­Ø§ÙØ¸</label>
                                <select class="form-select" id="shiftGuard" required>
                                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø­Ø§ÙØ¸...</option>
                                </select>
                            </div>
                            <div class="col-md-6 col-12">
                                <label class="form-label">ØªØ§Ø±ÛŒØ® Ø´ÛŒÙØª</label>
                                <input type="date" class="form-control" id="shiftDate" required>
                            </div>
                            <div class="col-md-4 col-12">
                                <label class="form-label">Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹</label>
                                <input type="time" class="form-control" id="startTime" required>
                            </div>
                            <div class="col-md-4 col-12">
                                <label class="form-label">Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù†</label>
                                <input type="time" class="form-control" id="endTime" required>
                            </div>
                            <div class="col-md-4 col-12">
                                <label class="form-label">Ù†ÙˆØ¹ Ø´ÛŒÙØª</label>
                                <select class="form-select" id="shiftType" required>
                                    <option value="Day">Ø´ÛŒÙØª Ø±ÙˆØ²</option>
                                    <option value="Night">Ø´ÛŒÙØª Ø´Ø¨</option>
                                    <option value="Day-Night">Ø´ÛŒÙØª Ø±ÙˆØ² Ùˆ Ø´Ø¨</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ø´ÛŒÙØª
                                </button>
                            </div>
                        </form>

                        <hr>
                        <h5><i class="fas fa-calendar-day"></i> Ø´ÛŒÙØªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</h5>
                        <div id="todayShiftsList" class="mt-3"></div>
                        
                        <h5 class="mt-4"><i class="fas fa-calendar-week"></i> ØªÙ…Ø§Ù… Ø´ÛŒÙØªâ€ŒÙ‡Ø§</h5>
                        <div id="allShiftsList" class="mt-3"></div>
                    </div>

                    <!-- Ø¨Ø®Ø´ Ú¯Ø²Ø§Ø±Ø´ Ø­ÙˆØ§Ø¯Ø« -->
                    <div id="incidents" class="section">
                        <h4><i class="fas fa-exclamation-circle"></i> Ú¯Ø²Ø§Ø±Ø´ Ø­Ø§Ø¯Ø«Ù‡ Ø¬Ø¯ÛŒØ¯</h4>
                        <form id="incidentForm" class="row g-3">
                            <div class="col-md-6 col-12">
                                <label class="form-label">Ù…Ø­Ø§ÙØ¸ Ù…Ø³Ø¦ÙˆÙ„</label>
                                <select class="form-select" id="incidentGuard" required>
                                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø­Ø§ÙØ¸...</option>
                                </select>
                            </div>
                            <div class="col-md-6 col-12">
                                <label class="form-label">ØªØ§Ø±ÛŒØ® Ùˆ Ø²Ù…Ø§Ù† Ø­Ø§Ø¯Ø«Ù‡</label>
                                <input type="datetime-local" class="form-control" id="incidentDateTime" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø­Ø§Ø¯Ø«Ù‡</label>
                                <input type="text" class="form-control" id="incidentTitle" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Ø´Ø±Ø­ Ú©Ø§Ù…Ù„ Ø­Ø§Ø¯Ø«Ù‡</label>
                                <textarea class="form-control" id="incidentDescription" rows="3" required></textarea>
                            </div>
                            <div class="col-md-6 col-12">
                                <label class="form-label">Ø³Ø·Ø­ Ø§Ù‡Ù…ÛŒØª</label>
                                <select class="form-select" id="incidentSeverity" required>
                                    <option value="Low">Ú©Ù…</option>
                                    <option value="Medium">Ù…ØªÙˆØ³Ø·</option>
                                    <option value="High">Ø²ÛŒØ§Ø¯</option>
                                    <option value="Critical">Ø¨Ø­Ø±Ø§Ù†ÛŒ</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-exclamation-triangle"></i> Ø«Ø¨Øª Ø­Ø§Ø¯Ø«Ù‡
                                </button>
                            </div>
                        </form>

                        <hr>
                        <h5><i class="fas fa-history"></i> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø­ÙˆØ§Ø¯Ø«</h5>
                        <div id="incidentsList" class="mt-3"></div>
                    </div>

                    <!-- Ø¨Ø®Ø´ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø±Ø®ØµÛŒ -->
                    <div id="leaves" class="section">
                        <h4><i class="fas fa-file-signature"></i> Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø±Ø®ØµÛŒ Ø¬Ø¯ÛŒØ¯</h4>
                        <form id="leaveForm" class="row g-3">
                            <div class="col-md-6 col-12">
                                <label class="form-label">Ù…Ø­Ø§ÙØ¸</label>
                                <select class="form-select" id="leaveGuard" required>
                                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø­Ø§ÙØ¸...</option>
                                </select>
                            </div>
                            <div class="col-md-6 col-12">
                                <label class="form-label">Ù†ÙˆØ¹ Ù…Ø±Ø®ØµÛŒ</label>
                                <select class="form-select" id="leaveType" required>
                                    <option value="Annual">Ù…Ø±Ø®ØµÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡</option>
                                    <option value="Sick">Ù…Ø±Ø®ØµÛŒ Ù…Ø±ÛŒØ¶ÛŒ</option>
                                    <option value="Emergency">Ù…Ø±Ø®ØµÛŒ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ</option>
                                    <option value="Maternity">Ø¹Ø§Ø¯ÛŒ</option>
                                </select>
                            </div>
                            <div class="col-md-6 col-12">
                                <label class="form-label">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</label>
                                <input type="date" class="form-control" id="leaveStart" required>
                            </div>
                            <div class="col-md-6 col-12">
                                <label class="form-label">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</label>
                                <input type="date" class="form-control" id="leaveEnd" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Ø¹Ù„Øª Ù…Ø±Ø®ØµÛŒ</label>
                                <textarea class="form-control" id="leaveReason" rows="2" required></textarea>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-info">
                                    <i class="fas fa-paper-plane"></i> Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª
                                </button>
                            </div>
                        </form>

                        <hr>
                        <h5><i class="fas fa-clipboard-list"></i> Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø®ØµÛŒ</h5>
                        <div id="leavesList" class="mt-3"></div>
                    </div>

                    <!-- Ø¨Ø®Ø´ Ú¯Ø²Ø§Ø±Ø´Ø§Øª -->
                    <div id="reports" class="section">
                        <h4><i class="fas fa-chart-pie"></i> Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ø³ÛŒØ³ØªÙ…</h4>
                        
                        <div class="row mb-4">
                            <div class="col-md-3 col-6 mb-3">
                                <div class="card text-white bg-primary h-100">
                                    <div class="card-body text-center">
                                        <h3 id="totalGuards">0</h3>
                                        <p>ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù…Ø­Ø§ÙØ¸Ø§Ù†</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="card text-white bg-success h-100">
                                    <div class="card-body text-center">
                                        <h3 id="todayShifts">0</h3>
                                        <p>Ø´ÛŒÙØªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="card text-white bg-warning h-100">
                                    <div class="card-body text-center">
                                        <h3 id="totalIncidents">0</h3>
                                        <p>Ø­ÙˆØ§Ø¯Ø« Ø«Ø¨Øª Ø´Ø¯Ù‡</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="card text-white bg-info h-100">
                                    <div class="card-body text-center">
                                        <h3 id="pendingLeaves">0</h3>
                                        <p>Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø®ØµÛŒ</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6 col-12 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <i class="fas fa-chart-bar"></i> ØªÙˆØ²ÛŒØ¹ Ù…Ø­Ø§ÙØ¸Ø§Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±ØªØ¨Ù‡
                                    </div>
                                    <div class="card-body">
                                        <div id="positionChart"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-12 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <i class="fas fa-chart-line"></i> ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±
                                    </div>
                                    <div class="card-body">
                                        <div id="activityChart"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6 col-12 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <i class="fas fa-exclamation-triangle"></i> ØªÙˆØ²ÛŒØ¹ Ø­ÙˆØ§Ø¯Ø« Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø·Ø­ Ø§Ù‡Ù…ÛŒØª
                                    </div>
                                    <div class="card-body">
                                        <div id="severityChart"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-12 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <i class="fas fa-umbrella-beach"></i> ÙˆØ¶Ø¹ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø®ØµÛŒ
                                    </div>
                                    <div class="card-body">
                                        <div id="leaveStatusChart"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyA_s-rHStZQPzuEjb_FpClS3Aaac1sidYQ",
            authDomain: "security-company-system.firebaseapp.com",
            databaseURL: "https://guard-e5328-default-rtdb.firebaseio.com",
            projectId: "security-company-system",
            storageBucket: "security-company-system.firebasestorage.app",
            messagingSenderId: "518820113373",
            appId: "1:518820113373:web:087d0b4ad1c202d590a434"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ==================== SYSTEM VARIABLES ====================
        let currentUser = null;
        let guards = [];
        let shifts = [];
        let incidents = [];
        let leaves = [];

        // ==================== INITIAL SETUP ====================
        async function createDefaultAdmin() {
            try {
                const adminData = {
                    Willcome,
                    To AHG Securety team database,
                    role: "admin",
                    firstName: "Ø°Ø¨ÛŒØ­ Ø§Ù„Ù„Ù‡",
                    lastName: "Ú©Ø§Ú©Ø±",
                    status: "active",
                    createdAt: new Date().toISOString()
                };
                
                const usersRef = database.ref('users');
                const snapshot = await usersRef.once('value');
                
                let adminExists = false;
                let adminKey = null;
                
                snapshot.forEach((child) => {
                    const user = child.val();
                    if (user.phone === "0780060833") {
                        adminExists = true;
                        adminKey = child.key;
                    }
                });
                
                if (adminExists && adminKey) {
                    await usersRef.child(adminKey).set(adminData);
                } else {
                    await usersRef.push(adminData);
                }
                
            } catch (error) {
                console.error("Error creating admin:", error);
            }
        }

        // ==================== LOGIN SYSTEM ====================
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            try {
                const usersRef = database.ref('users');
                const snapshot = await usersRef.once('value');
                
                let userFound = null;
                let userId = null;
                
                snapshot.forEach((child) => {
                    const user = child.val();
                    if (user.phone === phone && user.password === password) {
                        userFound = user;
                        userId = child.key;
                    }
                });
                
                if (userFound) {
                    currentUser = { id: userId, ...userFound };
                    
                    showMainSystem();
                    setupUserInterface();
                    loadAllData();
                } else {
                    throw new Error('Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
                }
                
            } catch (error) {
                alert(error.message);
            }
        });

        function showMainSystem() {
            document.getElementById('loginSystem').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'block';
        }

        function showLoginSystem() {
            document.getElementById('loginSystem').style.display = 'flex';
            document.getElementById('mainSystem').style.display = 'none';
            currentUser = null;
        }

        function setupUserInterface() {
            document.getElementById('userWelcome').textContent = `Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ ${currentUser.firstName}`;
            document.getElementById('userBadge').textContent = getRoleText(currentUser.role);
            document.getElementById('userBadge').className = `user-badge role-${currentUser.role}`;
            
            if (currentUser.role !== 'admin') {
                document.getElementById('addGuardBtn').style.display = 'none';
            }
        }

        function getRoleText(role) {
            const roles = {
                'admin': 'Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…',
                'manager': 'Ù…Ø¯ÛŒØ±',
                'guard': 'Ù…Ø­Ø§ÙØ¸'
            };
            return roles[role] || role;
        }

        function logout() {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯ØŸ')) {
                showLoginSystem();
            }
        }

        // ==================== DATA MANAGEMENT ====================
        function loadAllData() {
            loadGuards();
            loadShifts();
            loadIncidents();
            loadLeaves();
        }

        function loadGuards() {
            database.ref('guards').on('value', (snapshot) => {
                guards = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        guards.push({
                            id: child.key,
                            ...child.val()
                        });
                    });
                }
                loadGuardsList();
                populateGuardDropdowns();
                updateReports();
            });
        }

        function loadShifts() {
            database.ref('shifts').on('value', (snapshot) => {
                shifts = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        shifts.push({
                            id: child.key,
                            ...child.val()
                        });
                    });
                }
                loadShiftsList();
                updateReports();
            });
        }

        function loadIncidents() {
            database.ref('incidents').on('value', (snapshot) => {
                incidents = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        incidents.push({
                            id: child.key,
                            ...child.val()
                        });
                    });
                }
                loadIncidentsList();
                updateReports();
            });
        }

        function loadLeaves() {
            database.ref('leaves').on('value', (snapshot) => {
                leaves = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        leaves.push({
                            id: child.key,
                            ...child.val()
                        });
                    });
                }
                loadLeavesList();
                updateReports();
            });
        }

        // ==================== GUARD MANAGEMENT ====================
        document.getElementById('guardForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const fatherName = document.getElementById('fatherName').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const password = document.getElementById('guardPassword').value;
            const position = document.getElementById('position').value;
            const userRole = document.getElementById('userRole').value;
            const hireDate = document.getElementById('hireDate').value;

            try {
                // Check if phone exists
                const usersSnapshot = await database.ref('users').once('value');
                let phoneExists = false;
                
                usersSnapshot.forEach((child) => {
                    const user = child.val();
                    if (user.phone === phoneNumber) {
                        phoneExists = true;
                    }
                });
                
                if (phoneExists) {
                    alert('Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª');
                    return;
                }

                // Create guard data
                const guardData = {
                    firstName: firstName,
                    lastName: lastName,
                    fatherName: fatherName,
                    phoneNumber: phoneNumber,
                    position: position,
                    role: userRole,
                    hireDate: hireDate,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.id
                };

                // Create user account
                const userData = {
                    phone: phoneNumber,
                    password: password,
                    role: userRole,
                    firstName: firstName,
                    lastName: lastName,
                    position: position,
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.id
                };

                await database.ref('guards').push(guardData);
                await database.ref('users').push(userData);

                document.getElementById('guardForm').reset();
                hideAddGuardForm();
                showSaveIndicator();
                
                alert(`âœ… ${userRole === 'manager' ? 'Ù…Ø¯ÛŒØ±' : 'Ù…Ø­Ø§ÙØ¸'} Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯!\n\nØ´Ù…Ø§Ø±Ù‡: ${phoneNumber}\nØ±Ù…Ø²: ${password}`);

            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª: ' + error.message);
            }
        });

        function loadGuardsList() {
            const container = document.getElementById('guardsList');
            container.innerHTML = '';

            if (guards.length === 0) {
                container.innerHTML = '<div class="alert alert-info">Ù‡ÛŒÚ† Ù…Ø­Ø§ÙØ¸ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
                return;
            }

            guards.forEach(guard => {
                const positionText = getPositionText(guard.position);
                const serviceYears = calculateServiceYears(guard.hireDate);

                const guardItem = document.createElement('div');
                guardItem.className = 'guard-item';
                guardItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="profile-photo bg-light d-flex align-items-center justify-content-center">
                                <i class="fas fa-user text-muted"></i>
                            </div>
                            <div class="ms-3">
                                <h6 class="mb-1">${guard.firstName} ${guard.lastName}</h6>
                                <small class="text-muted">ğŸ“ ${guard.phoneNumber} | ğŸ“… ${guard.hireDate}</small>
                                <br>
                                <span class="badge bg-primary">${positionText}</span>
                                <span class="badge bg-secondary">${serviceYears} Ø³Ø§Ù„ Ø®Ø¯Ù…Øª</span>
                                <span class="badge ${guard.role === 'manager' ? 'bg-warning' : 'bg-info'}">${getRoleText(guard.role)}</span>
                            </div>
                        </div>
                        ${currentUser.role === 'admin' ? `
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteGuard('${guard.id}', '${guard.phoneNumber}')">
                                <i class="fas fa-trash"></i> Ø­Ø°Ù
                            </button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(guardItem);
            });
        }

        async function deleteGuard(guardId, phoneNumber) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;

            try {
                await database.ref('guards/' + guardId).remove();
                
                const usersSnapshot = await database.ref('users').once('value');
                usersSnapshot.forEach((child) => {
                    const user = child.val();
                    if (user.phone === phoneNumber && user.role !== 'admin') {
                        database.ref('users/' + child.key).remove();
                    }
                });
                
                showSaveIndicator();
                alert('Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±: ' + error.message);
            }
        }

        // ==================== SHIFT MANAGEMENT ====================
        function populateGuardDropdowns() {
            const dropdowns = ['shiftGuard', 'incidentGuard', 'leaveGuard'];
            dropdowns.forEach(dropdownId => {
                const select = document.getElementById(dropdownId);
                select.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø­Ø§ÙØ¸...</option>';
                guards.forEach(guard => {
                    select.innerHTML += `<option value="${guard.id}">${guard.firstName} ${guard.lastName}</option>`;
                });
            });
        }

        document.getElementById('shiftForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const guardId = document.getElementById('shiftGuard').value;
            const shiftDate = document.getElementById('shiftDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const shiftType = document.getElementById('shiftType').value;

            const guard = guards.find(g => g.id === guardId);
            if (!guard) {
                alert('Ù„Ø·ÙØ§ Ù…Ø­Ø§ÙØ¸ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }

            try {
                const shiftData = {
                    guardId: guardId,
                    guardName: `${guard.firstName} ${guard.lastName}`,
                    date: shiftDate,
                    startTime: startTime,
                    endTime: endTime,
                    type: shiftType,
                    status: 'Scheduled',
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.id
                };

                await database.ref('shifts').push(shiftData);
                document.getElementById('shiftForm').reset();
                showSaveIndicator();
                alert('âœ… Ø´ÛŒÙØª Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!');

            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø´ÛŒÙØª: ' + error.message);
            }
        });

        function loadShiftsList() {
            const todayContainer = document.getElementById('todayShiftsList');
            const allContainer = document.getElementById('allShiftsList');
            
            todayContainer.innerHTML = '';
            allContainer.innerHTML = '';

            const today = new Date().toISOString().split('T')[0];
            const todayShifts = shifts.filter(shift => shift.date === today);
            const allShifts = shifts.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (todayShifts.length === 0) {
                todayContainer.innerHTML = '<div class="alert alert-info">Ù‡ÛŒÚ† Ø´ÛŒÙØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
            } else {
                todayShifts.forEach(shift => {
                    todayContainer.appendChild(createShiftItem(shift));
                });
            }

            if (allShifts.length === 0) {
                allContainer.innerHTML = '<div class="alert alert-info">Ù‡ÛŒÚ† Ø´ÛŒÙØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
            } else {
                allShifts.forEach(shift => {
                    allContainer.appendChild(createShiftItem(shift));
                });
            }
        }

        function createShiftItem(shift) {
            const shiftTypeClass = shift.type === 'Day' ? 'day-shift' : 
                                 shift.type === 'Night' ? 'night-shift' : 'day-night-shift';
            const shiftTypeText = shift.type === 'Day' ? 'Ø´ÛŒÙØª Ø±ÙˆØ²' : 
                                shift.type === 'Night' ? 'Ø´ÛŒÙØª Ø´Ø¨' : 'Ø´ÛŒÙØª Ø±ÙˆØ² Ùˆ Ø´Ø¨';

            const shiftItem = document.createElement('div');
            shiftItem.className = 'shift-item';
            shiftItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${shift.guardName}</h6>
                        <small class="text-muted">ğŸ“… ${shift.date} | ğŸ•’ ${shift.startTime} - ${shift.endTime}</small>
                        <br>
                        <span class="badge shift-badge ${shiftTypeClass}">${shiftTypeText}</span>
                        <span class="badge bg-success">${shift.status}</span>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteShift('${shift.id}')">
                        <i class="fas fa-trash"></i> Ø­Ø°Ù
                    </button>
                </div>
            `;
            return shiftItem;
        }

        async function deleteShift(shiftId) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø´ÛŒÙØª Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;

            try {
                await database.ref('shifts/' + shiftId).remove();
                showSaveIndicator();
                alert('Ø´ÛŒÙØª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø´ÛŒÙØª: ' + error.message);
            }
        }

        // ==================== INCIDENT MANAGEMENT ====================
        document.getElementById('incidentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const guardId = document.getElementById('incidentGuard').value;
            const dateTime = document.getElementById('incidentDateTime').value;
            const title = document.getElementById('incidentTitle').value;
            const description = document.getElementById('incidentDescription').value;
            const severity = document.getElementById('incidentSeverity').value;

            const guard = guards.find(g => g.id === guardId);
            if (!guard) {
                alert('Ù„Ø·ÙØ§ Ù…Ø­Ø§ÙØ¸ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }

            try {
                const incidentData = {
                    guardId: guardId,
                    guardName: `${guard.firstName} ${guard.lastName}`,
                    dateTime: dateTime,
                    title: title,
                    description: description,
                    severity: severity,
                    status: 'Reported',
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.id
                };

                await database.ref('incidents').push(incidentData);
                document.getElementById('incidentForm').reset();
                showSaveIndicator();
                alert('âœ… Ø­Ø§Ø¯Ø«Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!');

            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø­Ø§Ø¯Ø«Ù‡: ' + error.message);
            }
        });

        function loadIncidentsList() {
            const container = document.getElementById('incidentsList');
            container.innerHTML = '';

            if (incidents.length === 0) {
                container.innerHTML = '<div class="alert alert-info">Ù‡ÛŒÚ† Ø­Ø§Ø¯Ø«Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
                return;
            }

            incidents.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime)).forEach(incident => {
                const severityClass = `severity-${incident.severity.toLowerCase()}`;
                const severityText = getSeverityText(incident.severity);

                const incidentItem = document.createElement('div');
                incidentItem.className = 'incident-item';
                incidentItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div style="flex: 1;">
                            <h6 class="mb-1">${incident.title}</h6>
                            <small class="text-muted">ğŸ‘® ${incident.guardName} | ğŸ“… ${new Date(incident.dateTime).toLocaleString('fa-IR')}</small>
                            <p class="mt-2 mb-1">${incident.description}</p>
                            <span class="badge ${severityClass}">${severityText}</span>
                            <span class="badge status-reported">${incident.status}</span>
                        </div>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteIncident('${incident.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(incidentItem);
            });
        }

        async function deleteIncident(incidentId) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø­Ø§Ø¯Ø«Ù‡ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;

            try {
                await database.ref('incidents/' + incidentId).remove();
                showSaveIndicator();
                alert('Ø­Ø§Ø¯Ø«Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø­Ø§Ø¯Ø«Ù‡: ' + error.message);
            }
        }

        // ==================== LEAVE MANAGEMENT ====================
        document.getElementById('leaveForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const guardId = document.getElementById('leaveGuard').value;
            const startDate = document.getElementById('leaveStart').value;
            const endDate = document.getElementById('leaveEnd').value;
            const type = document.getElementById('leaveType').value;
            const reason = document.getElementById('leaveReason').value;

            const guard = guards.find(g => g.id === guardId);
            if (!guard) {
                alert('Ù„Ø·ÙØ§ Ù…Ø­Ø§ÙØ¸ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }

            try {
                const leaveData = {
                    guardId: guardId,
                    guardName: `${guard.firstName} ${guard.lastName}`,
                    startDate: startDate,
                    endDate: endDate,
                    type: type,
                    reason: reason,
                    status: 'Pending',
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.id
                };

                await database.ref('leaves').push(leaveData);
                document.getElementById('leaveForm').reset();
                showSaveIndicator();
                alert('âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø±Ø®ØµÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!');

            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø±Ø®ØµÛŒ: ' + error.message);
            }
        });

        function loadLeavesList() {
            const container = document.getElementById('leavesList');
            container.innerHTML = '';

            if (leaves.length === 0) {
                container.innerHTML = '<div class="alert alert-info">Ù‡ÛŒÚ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø±Ø®ØµÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
                return;
            }

            leaves.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(leave => {
                const statusClass = `status-${leave.status.toLowerCase()}`;
                const statusText = getStatusText(leave.status);
                const typeText = getLeaveTypeText(leave.type);

                const leaveItem = document.createElement('div');
                leaveItem.className = 'leave-item';
                leaveItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${leave.guardName}</h6>
                            <small class="text-muted">ğŸ“… ${leave.startDate} ØªØ§ ${leave.endDate}</small>
                            <br>
                            <span class="badge bg-info">${typeText}</span>
                            <span class="badge ${statusClass}">${statusText}</span>
                            <br>
                            <small class="text-muted">${leave.reason}</small>
                        </div>
                        <div>
                            ${leave.status === 'Pending' && currentUser.role !== 'guard' ? `
                                <button class="btn btn-sm btn-success mt-1" onclick="updateLeaveStatus('${leave.id}', 'Approved')">
                                    <i class="fas fa-check"></i> ØªØ§ÛŒÛŒØ¯
                                </button>
                                <button class="btn btn-sm btn-danger mt-1" onclick="updateLeaveStatus('${leave.id}', 'Rejected')">
                                    <i class="fas fa-times"></i> Ø±Ø¯
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-outline-danger mt-1" onclick="deleteLeave('${leave.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(leaveItem);
            });
        }

        async function updateLeaveStatus(leaveId, status) {
            try {
                await database.ref('leaves/' + leaveId).update({ status: status });
                showSaveIndicator();
                alert(`âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø±Ø®ØµÛŒ ${status === 'Approved' ? 'ØªØ§ÛŒÛŒØ¯' : 'Ø±Ø¯'} Ø´Ø¯!`);
            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª: ' + error.message);
            }
        }

        async function deleteLeave(leaveId) {
            if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø±Ø®ØµÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;

            try {
                await database.ref('leaves/' + leaveId).remove();
                showSaveIndicator();
                alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø±Ø®ØµÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø±Ø®ØµÛŒ: ' + error.message);
            }
        }

        // ==================== REPORTS ====================
        function updateReports() {
            // Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ
            document.getElementById('totalGuards').textContent = guards.length;
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('todayShifts').textContent = shifts.filter(s => s.date === today).length;
            
            document.getElementById('totalIncidents').textContent = incidents.length;
            document.getElementById('pendingLeaves').textContent = leaves.filter(l => l.status === 'Pending').length;

            // Ù†Ù…ÙˆØ¯Ø§Ø± ØªÙˆØ²ÛŒØ¹ Ø±ØªØ¨Ù‡â€ŒÙ‡Ø§
            updatePositionChart();
            
            // Ù†Ù…ÙˆØ¯Ø§Ø± ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§
            updateActivityChart();
            
            // Ù†Ù…ÙˆØ¯Ø§Ø± Ø³Ø·Ø­ Ø§Ù‡Ù…ÛŒØª Ø­ÙˆØ§Ø¯Ø«
            updateSeverityChart();
            
            // Ù†Ù…ÙˆØ¯Ø§Ø± ÙˆØ¶Ø¹ÛŒØª Ù…Ø±Ø®ØµÛŒâ€ŒÙ‡Ø§
            updateLeaveStatusChart();
        }

        function updatePositionChart() {
            const positionCounts = {};
            guards.forEach(guard => {
                positionCounts[guard.position] = (positionCounts[guard.position] || 0) + 1;
            });

            let positionChartHTML = '';
            Object.keys(positionCounts).forEach(position => {
                const count = positionCounts[position];
                const percentage = guards.length > 0 ? ((count / guards.length) * 100).toFixed(1) : 0;
                positionChartHTML += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${getPositionText(position)}</span>
                        <span>${count} Ù†ÙØ± (${percentage}%)</span>
                    </div>
                    <div class="chart-bar" style="width: ${percentage}%"></div>
                `;
            });
            document.getElementById('positionChart').innerHTML = positionChartHTML || '<p class="text-muted">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</p>';
        }

        function updateActivityChart() {
            const today = new Date().toISOString().split('T')[0];
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            const recentShifts = shifts.filter(s => new Date(s.date) >= weekAgo).length;
            const recentIncidents = incidents.filter(i => new Date(i.dateTime) >= weekAgo).length;
            const recentLeaves = leaves.filter(l => new Date(l.createdAt) >= weekAgo).length;

            document.getElementById('activityChart').innerHTML = `
                <div class="activity-item">
                    <strong>Ø´ÛŒÙØªâ€ŒÙ‡Ø§ÛŒ Û· Ø±ÙˆØ² Ø§Ø®ÛŒØ±:</strong> ${recentShifts}
                </div>
                <div class="activity-item">
                    <strong>Ø­ÙˆØ§Ø¯Ø« Û· Ø±ÙˆØ² Ø§Ø®ÛŒØ±:</strong> ${recentIncidents}
                </div>
                <div class="activity-item">
                    <strong>Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø®ØµÛŒ Û· Ø±ÙˆØ² Ø§Ø®ÛŒØ±:</strong> ${recentLeaves}
                </div>
                <div class="activity-item">
                    <strong>Ø´ÛŒÙØªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²:</strong> ${shifts.filter(s => s.date === today).length}
                </div>
            `;
        }

        function updateSeverityChart() {
            const severityCounts = {
                'Low': 0,
                'Medium': 0,
                'High': 0,
                'Critical': 0
            };

            incidents.forEach(incident => {
                severityCounts[incident.severity]++;
            });

            let severityChartHTML = '';
            Object.keys(severityCounts).forEach(severity => {
                const count = severityCounts[severity];
                const percentage = incidents.length > 0 ? ((count / incidents.length) * 100).toFixed(1) : 0;
                severityChartHTML += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge severity-${severity.toLowerCase()}">${getSeverityText(severity)}</span>
                        <span>${count} Ù…ÙˆØ±Ø¯ (${percentage}%)</span>
                    </div>
                    <div class="chart-bar severity-${severity.toLowerCase()}" style="width: ${percentage}%"></div>
                `;
            });
            document.getElementById('severityChart').innerHTML = severityChartHTML || '<p class="text-muted">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</p>';
        }

        function updateLeaveStatusChart() {
            const statusCounts = {
                'Pending': 0,
                'Approved': 0,
                'Rejected': 0
            };

            leaves.forEach(leave => {
                statusCounts[leave.status]++;
            });

            let leaveStatusHTML = '';
            Object.keys(statusCounts).forEach(status => {
                const count = statusCounts[status];
                const percentage = leaves.length > 0 ? ((count / leaves.length) * 100).toFixed(1) : 0;
                leaveStatusHTML += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge status-${status.toLowerCase()}">${getStatusText(status)}</span>
                        <span>${count} Ù…ÙˆØ±Ø¯ (${percentage}%)</span>
                    </div>
                    <div class="chart-bar status-${status.toLowerCase()}" style="width: ${percentage}%"></div>
                `;
            });
            document.getElementById('leaveStatusChart').innerHTML = leaveStatusHTML || '<p class="text-muted">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</p>';
        }

        // ==================== HELPER FUNCTIONS ====================
        function getPositionText(position) {
            const positions = {
                'Officer': 'Ø§ÙØ³Ø±',
                'Second_Lieutenant': 'Ø³Ø§ØªÙ†Ù…Ù†',
                'First_Lieutenant': 'Ù„ÙˆÙ…Ú“ÛŒ Ø³Ø§ØªÙ†Ù…Ù†', 
                'Second_Lieutenant_Junior': 'Ø¯ÙˆÛŒÙ… Ø³Ø§ØªÙ†Ù…Ù†',
                'Guard': 'Ú«Ø§Ø±Ø¯'
            };
            return positions[position] || position;
        }

        function getSeverityText(severity) {
            const severities = {
                'Low': 'Ú©Ù…',
                'Medium': 'Ù…ØªÙˆØ³Ø·',
                'High': 'Ø²ÛŒØ§Ø¯',
                'Critical': 'Ø¨Ø­Ø±Ø§Ù†ÛŒ'
            };
            return severities[severity] || severity;
        }

        function getStatusText(status) {
            const statuses = {
                'Pending': 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±',
                'Approved': 'ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡',
                'Rejected': 'Ø±Ø¯ Ø´Ø¯Ù‡',
                'Reported': 'Ú¯Ø²Ø§Ø±Ø´ Ø´Ø¯Ù‡'
            };
            return statuses[status] || status;
        }

        function getLeaveTypeText(type) {
            const types = {
                'Annual': 'Ù…Ø±Ø®ØµÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡',
                'Sick': 'Ù…Ø±Ø®ØµÛŒ Ù…Ø±ÛŒØ¶ÛŒ',
                'Emergency': 'Ù…Ø±Ø®ØµÛŒ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ',
                'Maternity': 'Ù…Ø±Ø®ØµÛŒ Ø²Ø§ÛŒÙ…Ø§Ù†'
            };
            return types[type] || type;
        }

        function calculateServiceYears(hireDate) {
            const hire = new Date(hireDate);
            const now = new Date();
            const years = now.getFullYear() - hire.getFullYear();
            return years > 0 ? years : 1;
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            
            document.querySelectorAll('.list-group-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById(sectionId).style.display = 'block';
        }

        function showAddGuardForm() {
            document.getElementById('addGuardForm').style.display = 'block';
        }

        function hideAddGuardForm() {
            document.getElementById('addGuardForm').style.display = 'none';
            document.getElementById('guardForm').reset();
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            createDefaultAdmin();
        });
    </script>
</body>
</html>
