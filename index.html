<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AHG guard managemant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif;
        }

        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }

        /* ✨ Glassmorphism Login Styles */
        .auth-container {
            height: 100vh;
            background: url("https://images.unsplash.com/photo-1507525428034-b723cf961d3e")
                        no-repeat center center/cover;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        /* Lighter overlay to show more of the background picture */
        .auth-container::before {
            content: "";
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(2px);
        }

        .glass-container {
            position: relative;
            z-index: 10;
            width: 350px;
            padding: 40px 30px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.10);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.25);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            color: white;
            text-align: center;
        }

        .glass-container h2 {
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 600;
            color: #fff;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        .input-box {
            width: 100%;
            margin: 15px 0;
            position: relative;
        }

        .input-box input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: none;
            outline: none;
            background: rgba(255, 255, 255, 0.25);
            color: #fff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input-box input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .input-box input:focus {
            background: rgba(255, 255, 255, 0.35);
            box-shadow: 0 0 8px rgba(255,255,255,0.5);
        }

        .btn-glass {
            width: 100%;
            margin-top: 25px;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.3);
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-glass:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255,255,255,0.5);
        }

        .links {
            margin-top: 20px;
            font-size: 14px;
        }

        .links a {
            color: #fff;
            text-decoration: none;
            font-weight: 500;
        }

        .links a:hover {
            text-decoration: underline;
        }

        /* Decorative glowing circles */
        .circle1, .circle2 {
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            filter: blur(100px);
            z-index: 1;
        }

        .circle1 {
            width: 300px;
            height: 300px;
            top: -100px;
            left: -100px;
        }

        .circle2 {
            width: 250px;
            height: 250px;
            bottom: -80px;
            right: -80px;
        }

        /* Info alert styling for glass container */
        .glass-alert {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }

        .glass-alert small {
            color: rgba(255, 255, 255, 0.9);
        }

        /* Original System Styles */
        .main-system {
            display: none;
        }

        /* استایل‌های اصلی سیستم */
        body.main-system-active {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            overflow: auto;
        }

        .navbar-brand {
            font-weight: 700;
        }

        .user-badge {
            background: var(--success-color);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-right: 10px;
        }

        .section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            display: none;
        }

        #guards {
            display: block;
        }

        .guard-item, .shift-item, .incident-item, .leave-item {
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .guard-item:hover, .shift-item:hover, .incident-item:hover, .leave-item:hover {
            background: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .badge {
            font-size: 0.75em;
            margin: 2px;
        }

        .profile-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--secondary-color);
        }

        .profile-photo-large {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid var(--secondary-color);
            margin: 0 auto 20px;
        }

        .profile-photo-placeholder {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            margin: 0 auto 20px;
            border: 5px solid var(--secondary-color);
        }

        .list-group-item {
            border: none;
            padding: 15px 20px;
            font-weight: 600;
            border-radius: 10px !important;
            margin-bottom: 5px;
            transition: all 0.3s ease;
        }

        .list-group-item:hover {
            background: #e9ecef;
        }

        .list-group-item.active {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            border-color: var(--secondary-color);
        }

        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            display: none;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .shift-badge {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .day-shift {
            background-color: #ffc107;
            color: #000;
        }

        .night-shift {
            background-color: #343a40;
            color: #fff;
        }

        .scorting-shift {
            background-color: #0dcaf0;
            color: #000;
        }

        .scorting-money-vip-shift {
            background-color: #6610f2;
            color: #fff;
        }

        .severity-low { background-color: #198754; color: white; }
        .severity-medium { background-color: #ffc107; color: #000; }
        .severity-high { background-color: #fd7e14; color: white; }
        .severity-critical { background-color: #dc3545; color: white; }
        .status-pending { background-color: #6c757d; color: white; }
        .status-approved { background-color: #198754; color: white; }
        .status-rejected { background-color: #dc3545; color: white; }
        .status-reported { background-color: #0dcaf0; color: #000; }

        .role-admin { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .role-manager { background: linear-gradient(135deg, #3498db, #2980b9); }
        .role-guard { background: linear-gradient(135deg, #27ae60, #229954); }

        .chart-bar {
            background: #0d6efd;
            height: 20px;
            margin: 5px 0;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .activity-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        /* Profile Modal Styles */
        .profile-detail-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .profile-detail-label {
            font-weight: 600;
            color: var(--primary-color);
            min-width: 120px;
        }

        /* Image Preview */
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }

        /* File Input Styling */
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-container input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: 10px 15px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            background: #e9ecef;
            border-color: var(--secondary-color);
        }

        .file-input-label i {
            margin-left: 8px;
        }

        /* Search and Filter */
        .search-box {
            max-width: 400px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .glass-container {
                padding: 30px 20px;
                margin: 10px;
            }
            
            .section {
                padding: 20px;
            }
            
            .guard-item, .shift-item, .incident-item, .leave-item {
                padding: 15px;
            }

            .profile-photo-large, .profile-photo-placeholder {
                width: 120px;
                height: 120px;
            }
        }

        @media (max-width: 576px) {
            .glass-container {
                padding: 25px 15px;
            }
            
            .section {
                padding: 15px;
            }

            .profile-photo-large, .profile-photo-placeholder {
                width: 100px;
                height: 100px;
            }
        }

        /* ==================== SIDEBAR STYLES ==================== */
        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1050;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            width: 45px;
            height: 45px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: 280px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            z-index: 1040;
            padding: 20px 0;
            overflow-y: auto;
            transition: transform 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 15px;
            text-align: center;
        }

        .sidebar-header h4 {
            margin: 0;
            font-size: 1.2rem;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            margin: 0;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            border-right: 3px solid transparent;
        }

        .sidebar-menu a:hover {
            background: rgba(255,255,255,0.1);
            border-right-color: white;
        }

        .sidebar-menu a.active {
            background: rgba(255,255,255,0.2);
            border-right-color: white;
        }

        .sidebar-menu i {
            margin-left: 10px;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1039;
            display: none;
        }

        @media (max-width: 991.98px) {
            .sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .sidebar {
                transform: translateX(100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay.active {
                display: block;
            }
        }

        @media (min-width: 992px) {
            .sidebar {
                transform: translateX(0) !important;
            }
            
            .main-content {
                margin-right: 280px;
            }
        }
    </style>
</head>
<body>
    <!-- نشانگر ذخیره خودکار -->
    <div class="auto-save-indicator" id="saveIndicator">
        <i class="fas fa-check-circle"></i> داده‌ها ذخیره شد
    </div>

    <!-- سیستم لاگین -->
    <div id="loginSystem" class="auth-container">
        <div class="circle1"></div>
        <div class="circle2"></div>

        <div class="glass-container">
            <div class="auth-header">
                <div class="auth-logo" style="background: transparent; margin-bottom: 20px;">
                    <i class="fas fa-shield-alt" style="font-size: 3rem; color: white;"></i>
                </div>
                <h2>ورود به سیستم</h2>
                <p style="color: rgba(255,255,255,0.8); margin-bottom: 30px;">لطفا اطلاعات کاربری خود را وارد کنید</p>
            </div>
            
            <form id="loginForm">
                <div class="input-box">
                    <input type="text" id="loginPhone" required placeholder="شماره تماس" value="0780060833">
                </div>
                <div class="input-box">
                    <input type="password" id="loginPassword" required placeholder="رمز عبور" value="admin123">
                </div>
                <button type="submit" class="btn-glass">
                    <i class="fas fa-sign-in-alt"></i> ورود به سیستم
                </button>
                
                <div class="glass-alert">
                    <small>
                        <i class="fas fa-info-circle"></i> 
                        <strong>خوش آمدید:</strong><br>
                        به پایگاه داده محافظان AHG
                    </small>
                </div>
            </form>
        </div>
    </div>

    <!-- سیستم اصلی -->
    <div id="mainSystem" class="main-system">
        <!-- دکمه باز/بستن منو برای موبایل -->
        <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
        </button>

        <!-- منوی کناری -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h4><i class="fas fa-shield-alt"></i> منوی سیستم</h4>
            </div>
            <ul class="sidebar-menu">
                <li>
                    <a href="#guards" class="active" onclick="showSection('guards')">
                        <i class="fas fa-users"></i> مدیریت محافظان
                    </a>
                </li>
                <li>
                    <a href="#shifts" onclick="showSection('shifts')">
                        <i class="fas fa-calendar-alt"></i> مدیریت شیفت‌ها
                    </a>
                </li>
                <li>
                    <a href="#incidents" onclick="showSection('incidents')">
                        <i class="fas fa-exclamation-triangle"></i> گزارش حوادث
                    </a>
                </li>
                <li>
                    <a href="#leaves" onclick="showSection('leaves')">
                        <i class="fas fa-umbrella-beach"></i> مدیریت مرخصی
                    </a>
                </li>
                <li>
                    <a href="#reports" onclick="showSection('reports')">
                        <i class="fas fa-chart-bar"></i> گزارشات
                    </a>
                </li>
            </ul>
        </div>

        <!-- لایه محو برای موبایل -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- محتوای اصلی -->
        <div class="main-content">
            <!-- نوار بالایی -->
            <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));">
                <div class="container-fluid">
                    <span class="navbar-brand mb-0 h1">
                        <i class="fas fa-shield-alt"></i> سیستم مدیریت شرکت محافظ
                        <small class="fs-6 d-block">
                            <span id="userWelcome">خوش آمدید</span>
                            <span id="userBadge" class="user-badge"></span>
                        </small>
                    </span>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <div class="navbar-nav ms-auto d-flex align-items-center">
                            <button class="btn btn-outline-light btn-sm" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i> خروج
                            </button>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="container-fluid mt-4">
                <div class="row">
                    <!-- محتوای اصلی -->
                    <div class="col-12">
                        <!-- بخش مدیریت محافظان -->
                        <div id="guards" class="section">
                            <!-- نمایش برای مدیران -->
                            <div id="adminGuardView" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h4><i class="fas fa-users"></i> مدیریت محافظان</h4>
                                    <button id="addGuardBtn" class="btn btn-success" onclick="showAddGuardForm()">
                                        <i class="fas fa-user-plus"></i> افزودن محافظ
                                    </button>
                                </div>

                                <!-- جستجو و فیلتر -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <input type="text" id="searchGuards" class="form-control" placeholder="جستجو بر اساس نام یا شماره تماس...">
                                            <button class="btn btn-outline-secondary" type="button" onclick="searchGuards()">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select id="filterRole" class="form-select" onchange="filterGuards()">
                                            <option value="">همه نقش‌ها</option>
                                            <option value="guard">محافظ</option>
                                            <option value="manager">مدیر</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select id="filterGuardCategory" class="form-select" onchange="filterGuards()">
                                            <option value="">همه دسته‌ها</option>
                                            <option value="mobile">محافظ موبایل</option>
                                            <option value="office">محافظ دفتر</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- فرم افزودن محافظ -->
                                <div id="addGuardForm" class="card mb-4" style="display: none;">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">ثبت محافظ جدید</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="guardForm" class="row g-3">
                                            <div class="col-md-4 col-12">
                                                <label class="form-label">نام</label>
                                                <input type="text" class="form-control" id="firstName" required>
                                            </div>
                                            <div class="col-md-4 col-12">
                                                <label class="form-label">تخلص</label>
                                                <input type="text" class="form-control" id="lastName" required>
                                            </div>
                                            <div class="col-md-4 col-12">
                                                <label class="form-label">نام پدر</label>
                                                <input type="text" class="form-control" id="fatherName" required>
                                            </div>
                                            
                                            <div class="col-md-6 col-12">
                                                <label class="form-label">شماره تماس</label>
                                                <input type="text" class="form-control" id="phoneNumber" required>
                                            </div>
                                            <div class="col-md-6 col-12">
                                                <label class="form-label">رمز عبور</label>
                                                <input type="password" class="form-control" id="guardPassword" required>
                                            </div>

                                            <!-- Location Fields -->
                                            <div class="col-md-4 col-12">
                                                <label class="form-label">کشور</label>
                                                <input type="text" class="form-control" id="country" value="افغانستان" required>
                                            </div>
                                            <div class="col-md-4 col-12">
                                                <label class="form-label">ولایت</label>
                                                <input type="text" class="form-control" id="province" required>
                                            </div>
                                            <div class="col-md-4 col-12">
                                                <label class="form-label">ولسوالی</label>
                                                <input type="text" class="form-control" id="district" required>
                                            </div>

                                            <div class="col-md-6 col-12">
                                                <label class="form-label">رتبه</label>
                                                <select class="form-select" id="position" required>
                                                    <option value="Guard">ګارد - Guard</option>
                                                    <option value="Officer">افسر - Officer</option>
                                                    <option value="Second_Lieutenant">ساتنمن - Second Lieutenant</option>
                                                    <option value="First_Lieutenant">لومړی ساتنمن - First Lieutenant</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 col-12">
                                                <label class="form-label">دسته محافظ</label>
                                                <select class="form-select" id="guardCategory" required>
                                                    <option value="mobile">محافظ موبایل (اسکورت)</option>
                                                    <option value="office">محافظ دفتر (جستجو، نظارت، پذیرش)</option>
                                                </select>
                                            </div>
                                            
                                            <div class="col-md-6 col-12">
                                                <label class="form-label">نقش کاربر</label>
                                                <select class="form-select" id="userRole" required>
                                                    <option value="guard">محافظ</option>
                                                    <option value="manager">مدیر</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 col-12">
                                                <label class="form-label">تاریخ استخدام</label>
                                                <input type="date" class="form-control" id="hireDate" required>
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label">عکس پروفایل</label>
                                                <div class="file-input-container">
                                                    <input type="file" class="form-control" id="profilePhoto" accept="image/*" onchange="previewImage(this)">
                                                    <label for="profilePhoto" class="file-input-label">
                                                        <i class="fas fa-cloud-upload-alt"></i>
                                                        انتخاب عکس از کامپیوتر
                                                    </label>
                                                </div>
                                                <img id="imagePreview" class="image-preview mt-2" alt="پیش‌نمایش عکس">
                                                <small class="text-muted">حداکثر سایز: 2MB - فرمت‌های مجاز: JPG, PNG</small>
                                            </div>
                                            
                                            <div class="col-12">
                                                <button type="submit" class="btn btn-success me-2">
                                                    <i class="fas fa-save"></i> ثبت محافظ
                                                </button>
                                                <button type="button" class="btn btn-secondary" onclick="hideAddGuardForm()">
                                                    <i class="fas fa-times"></i> لغو
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>

                                <h5><i class="fas fa-list"></i> لیست محافظان</h5>
                                <div id="guardsList" class="mt-3"></div>
                            </div>

                            <!-- نمایش برای محافظان عادی -->
                            <div id="guardProfileView" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h4><i class="fas fa-user"></i> پروفایل من</h4>
                                    <button class="btn btn-outline-primary" onclick="editMyProfile()">
                                        <i class="fas fa-edit"></i> ویرایش پروفایل
                                    </button>
                                </div>
                                <div id="guardProfileDetails" class="card">
                                    <div class="card-body">
                                        <!-- پروفایل محافظ در اینجا نمایش داده می‌شود -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- بخش مدیریت شیفت‌ها -->
                        <div id="shifts" class="section">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4><i class="fas fa-calendar-alt"></i> مدیریت شیفت‌ها</h4>
                                <button id="addShiftBtn" class="btn btn-success" onclick="showAddShiftForm()">
                                    <i class="fas fa-plus"></i> افزودن شیفت
                                </button>
                            </div>

                            <!-- جستجو و فیلتر شیفت‌ها -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <input type="text" id="searchShifts" class="form-control" placeholder="جستجو بر اساس نام محافظ...">
                                </div>
                                <div class="col-md-3">
                                    <select id="filterShiftType" class="form-select" onchange="filterShifts()">
                                        <option value="">همه شیفت‌ها</option>
                                        <option value="day">شیفت روز</option>
                                        <option value="night">شیفت شب</option>
                                        <option value="scorting">شیفت اسکورت</option>
                                        <option value="scorting-money-vip">اسکورت پول و افراد VIP</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="date" id="filterShiftDate" class="form-control" onchange="filterShifts()">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-outline-secondary w-100" onclick="clearShiftFilters()">
                                        <i class="fas fa-times"></i> پاک کردن
                                    </button>
                                </div>
                            </div>

                            <!-- فرم افزودن شیفت -->
                            <div id="addShiftForm" class="card mb-4" style="display: none;">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">ثبت شیفت جدید</h5>
                                </div>
                                <div class="card-body">
                                    <form id="shiftForm" class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">انتخاب محافظ</label>
                                            <select class="form-select" id="shiftGuardId" required>
                                                <option value="">انتخاب محافظ</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">نوع شیفت</label>
                                            <select class="form-select" id="shiftType" required>
                                                <option value="day">شیفت روز (8:00 - 16:00)</option>
                                                <option value="night">شیفت شب (16:00 - 8:00)</option>
                                                <option value="scorting">شیفت اسکورت</option>
                                                <option value="scorting-money-vip">اسکورت پول و افراد VIP</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">تاریخ شیفت</label>
                                            <input type="date" class="form-control" id="shiftDate" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">محل خدمت</label>
                                            <input type="text" class="form-control" id="shiftLocation" required>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">توضیحات</label>
                                            <textarea class="form-control" id="shiftDescription" rows="3"></textarea>
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-success me-2">
                                                <i class="fas fa-save"></i> ثبت شیفت
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="hideAddShiftForm()">
                                                <i class="fas fa-times"></i> لغو
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <h5><i class="fas fa-list"></i> لیست شیفت‌ها</h5>
                            <div id="shiftsList" class="mt-3"></div>
                        </div>

                        <!-- بخش گزارش حوادث -->
                        <div id="incidents" class="section">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4><i class="fas fa-exclamation-triangle"></i> گزارش حوادث</h4>
                                <button id="addIncidentBtn" class="btn btn-success" onclick="showAddIncidentForm()">
                                    <i class="fas fa-plus"></i> گزارش حادثه جدید
                                </button>
                            </div>

                            <!-- جستجو و فیلتر حوادث -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <input type="text" id="searchIncidents" class="form-control" placeholder="جستجو بر اساس عنوان یا نام محافظ...">
                                </div>
                                <div class="col-md-3">
                                    <select id="filterSeverity" class="form-select" onchange="filterIncidents()">
                                        <option value="">همه سطوح</option>
                                        <option value="Low">کم</option>
                                        <option value="Medium">متوسط</option>
                                        <option value="High">زیاد</option>
                                        <option value="Critical">بحرانی</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select id="filterStatus" class="form-select" onchange="filterIncidents()">
                                        <option value="">همه وضعیت‌ها</option>
                                        <option value="Reported">گزارش شده</option>
                                        <option value="Under Investigation">در حال بررسی</option>
                                        <option value="Resolved">حل شده</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-outline-secondary w-100" onclick="clearIncidentFilters()">
                                        <i class="fas fa-times"></i> پاک کردن
                                    </button>
                                </div>
                            </div>

                            <!-- فرم افزودن حادثه -->
                            <div id="addIncidentForm" class="card mb-4" style="display: none;">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">ثبت حادثه جدید</h5>
                                </div>
                                <div class="card-body">
                                    <form id="incidentForm" class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">انتخاب محافظ</label>
                                            <select class="form-select" id="incidentGuardId" required>
                                                <option value="">انتخاب محافظ</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">عنوان حادثه</label>
                                            <input type="text" class="form-control" id="incidentTitle" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">تاریخ حادثه</label>
                                            <input type="datetime-local" class="form-control" id="incidentDate" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">محل حادثه</label>
                                            <input type="text" class="form-control" id="incidentLocation" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">سطح حادثه</label>
                                            <select class="form-select" id="incidentSeverity" required>
                                                <option value="Low">کم</option>
                                                <option value="Medium">متوسط</option>
                                                <option value="High">زیاد</option>
                                                <option value="Critical">بحرانی</option>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">شرح حادثه</label>
                                            <textarea class="form-control" id="incidentDescription" rows="4" required></textarea>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">اقدامات انجام شده</label>
                                            <textarea class="form-control" id="incidentActions" rows="3"></textarea>
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-success me-2">
                                                <i class="fas fa-save"></i> ثبت حادثه
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="hideAddIncidentForm()">
                                                <i class="fas fa-times"></i> لغو
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <h5><i class="fas fa-list"></i> لیست حوادث</h5>
                            <div id="incidentsList" class="mt-3"></div>
                        </div>

                        <!-- بخش مدیریت مرخصی -->
                        <div id="leaves" class="section">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4><i class="fas fa-umbrella-beach"></i> مدیریت مرخصی</h4>
                                <button id="addLeaveBtn" class="btn btn-success" onclick="showAddLeaveForm()">
                                    <i class="fas fa-plus"></i> درخواست مرخصی جدید
                                </button>
                            </div>

                            <!-- جستجو و فیلتر مرخصی‌ها -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <input type="text" id="searchLeaves" class="form-control" placeholder="جستجو بر اساس نام محافظ...">
                                </div>
                                <div class="col-md-3">
                                    <select id="filterLeaveType" class="form-select" onchange="filterLeaves()">
                                        <option value="">همه انواع</option>
                                        <option value="Annual">مرخصی روزانه</option>
                                        <option value="Sick">مرخصی مریضی</option>
                                        <option value="Emergency">مرخصی اضطراری</option>
                                        <option value="Maternity">مرخصی زایمان</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select id="filterLeaveStatus" class="form-select" onchange="filterLeaves()">
                                        <option value="">همه وضعیت‌ها</option>
                                        <option value="Pending">در انتظار</option>
                                        <option value="Approved">تایید شده</option>
                                        <option value="Rejected">رد شده</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-outline-secondary w-100" onclick="clearLeaveFilters()">
                                        <i class="fas fa-times"></i> پاک کردن
                                    </button>
                                </div>
                            </div>

                            <!-- فرم افزودن مرخصی -->
                            <div id="addLeaveForm" class="card mb-4" style="display: none;">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">درخواست مرخصی جدید</h5>
                                </div>
                                <div class="card-body">
                                    <form id="leaveForm" class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">انتخاب محافظ</label>
                                            <select class="form-select" id="leaveGuardId" required>
                                                <option value="">انتخاب محافظ</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">نوع مرخصی</label>
                                            <select class="form-select" id="leaveType" required>
                                                <option value="Annual">مرخصی روزانه</option>
                                                <option value="Sick">مرخصی مریضی</option>
                                                <option value="Emergency">مرخصی اضطراری</option>
                                                <option value="Maternity">مرخصی زایمان</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">تاریخ شروع</label>
                                            <input type="date" class="form-control" id="leaveStartDate" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">تاریخ پایان</label>
                                            <input type="date" class="form-control" id="leaveEndDate" required>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">دلیل مرخصی</label>
                                            <textarea class="form-control" id="leaveReason" rows="3" required></textarea>
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-success me-2">
                                                <i class="fas fa-save"></i> ثبت درخواست
                                            </button>
                                            <button type="button" class="btn btn-secondary" onclick="hideAddLeaveForm()">
                                                <i class="fas fa-times"></i> لغو
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <h5><i class="fas fa-list"></i> لیست درخواست‌های مرخصی</h5>
                            <div id="leavesList" class="mt-3"></div>
                        </div>

                        <!-- بخش گزارشات -->
                        <div id="reports" class="section">
                            <h4><i class="fas fa-chart-bar"></i> گزارشات و آمار</h4>
                            
                            <div class="row mb-4">
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="card text-center bg-primary text-white">
                                        <div class="card-body">
                                            <h3 id="totalGuards">0</h3>
                                            <p class="mb-0">تعداد محافظان</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="card text-center bg-success text-white">
                                        <div class="card-body">
                                            <h3 id="totalShifts">0</h3>
                                            <p class="mb-0">شیفت‌های فعال</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="card text-center bg-warning text-dark">
                                        <div class="card-body">
                                            <h3 id="totalIncidents">0</h3>
                                            <p class="mb-0">حوادث گزارش شده</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-3">
                                    <div class="card text-center bg-info text-white">
                                        <div class="card-body">
                                            <h3 id="pendingLeaves">0</h3>
                                            <p class="mb-0">مرخصی‌های در انتظار</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <div class="card">
                                        <div class="card-header bg-secondary text-white">
                                            <h5 class="mb-0">توزیع محافظان بر اساس رتبه</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="positionChart"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card">
                                        <div class="card-header bg-secondary text-white">
                                            <h5 class="mb-0">آمار حوادث بر اساس سطح</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="incidentChart"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-secondary text-white">
                                            <h5 class="mb-0">گزارش فعالیت‌های اخیر</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="recentActivities"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال نمایش جزئیات محافظ -->
    <div class="modal fade" id="guardDetailModal" tabindex="-1" aria-labelledby="guardDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="guardDetailModalLabel">
                        <i class="fas fa-user-circle"></i> جزئیات محافظ
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="guardDetailContent">
                    <!-- محتوای جزئیات محافظ در اینجا نمایش داده می‌شود -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> بستن
                    </button>
                    <button type="button" class="btn btn-warning" id="editGuardBtn" onclick="editGuard()">
                        <i class="fas fa-edit"></i> ویرایش
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال ویرایش محافظ -->
    <div class="modal fade" id="editGuardModal" tabindex="-1" aria-labelledby="editGuardModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title" id="editGuardModalLabel">
                        <i class="fas fa-edit"></i> ویرایش محافظ
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editGuardForm" class="row g-3">
                        <input type="hidden" id="editGuardId">
                        <div class="col-md-4 col-12">
                            <label class="form-label">نام</label>
                            <input type="text" class="form-control" id="editFirstName" required>
                        </div>
                        <div class="col-md-4 col-12">
                            <label class="form-label">تخلص</label>
                            <input type="text" class="form-control" id="editLastName" required>
                        </div>
                        <div class="col-md-4 col-12">
                            <label class="form-label">نام پدر</label>
                            <input type="text" class="form-control" id="editFatherName" required>
                        </div>
                        
                        <div class="col-md-6 col-12">
                            <label class="form-label">شماره تماس</label>
                            <input type="text" class="form-control" id="editPhoneNumber" required>
                        </div>
                        <div class="col-md-6 col-12">
                            <label class="form-label">رمز عبور جدید (اختیاری)</label>
                            <input type="password" class="form-control" id="editPassword" placeholder="در صورت تغییر رمز وارد کنید">
                        </div>

                        <div class="col-md-4 col-12">
                            <label class="form-label">کشور</label>
                            <input type="text" class="form-control" id="editCountry" required>
                        </div>
                        <div class="col-md-4 col-12">
                            <label class="form-label">ولایت</label>
                            <input type="text" class="form-control" id="editProvince" required>
                        </div>
                        <div class="col-md-4 col-12">
                            <label class="form-label">ولسوالی</label>
                            <input type="text" class="form-control" id="editDistrict" required>
                        </div>

                        <div class="col-md-6 col-12">
                            <label class="form-label">رتبه</label>
                            <select class="form-select" id="editPosition" required>
                                <option value="Guard">ګارد - Guard</option>
                                <option value="Officer">افسر - Officer</option>
                                <option value="Second_Lieutenant">ساتنمن - Second Lieutenant</option>
                                <option value="First_Lieutenant">لومړی ساتنمن - First Lieutenant</option>
                            </select>
                        </div>
                        <div class="col-md-6 col-12">
                            <label class="form-label">دسته محافظ</label>
                            <select class="form-select" id="editGuardCategory" required>
                                <option value="mobile">محافظ موبایل (اسکورت)</option>
                                <option value="office">محافظ دفتر (جستجو، نظارت، پذیرش)</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 col-12">
                            <label class="form-label">نقش کاربر</label>
                            <select class="form-select" id="editUserRole" required>
                                <option value="guard">محافظ</option>
                                <option value="manager">مدیر</option>
                            </select>
                        </div>
                        <div class="col-md-6 col-12">
                            <label class="form-label">تاریخ استخدام</label>
                            <input type="date" class="form-control" id="editHireDate" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">عکس پروفایل جدید</label>
                            <div class="file-input-container">
                                <input type="file" class="form-control" id="editProfilePhoto" accept="image/*" onchange="previewEditImage(this)">
                                <label for="editProfilePhoto" class="file-input-label">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    انتخاب عکس جدید
                                </label>
                            </div>
                            <img id="editImagePreview" class="image-preview mt-2" alt="پیش‌نمایش عکس">
                            <small class="text-muted">اگر می‌خواهید عکس را تغییر دهید، عکس جدیدی انتخاب کنید</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> لغو
                    </button>
                    <button type="button" class="btn btn-success" onclick="updateGuard()">
                        <i class="fas fa-save"></i> ذخیره تغییرات
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال تایید شماره تکراری -->
    <div class="modal fade" id="duplicatePhoneModal" tabindex="-1" aria-labelledby="duplicatePhoneModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title" id="duplicatePhoneModalLabel">
                        <i class="fas fa-exclamation-triangle"></i> شماره تماس تکراری
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>شماره تماس <strong id="duplicatePhoneNumber"></strong> قبلاً در سیستم ثبت شده است.</p>
                    <p>آیا مطمئن هستید که می‌خواهید این شماره را دوباره ثبت کنید؟</p>
                    <div class="alert alert-info">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            توجه: ثبت شماره تکراری ممکن است باعث مشکلاتی در سیستم شود.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> لغو
                    </button>
                    <button type="button" class="btn btn-warning" id="confirmDuplicate">
                        <i class="fas fa-check"></i> بله، ثبت کن
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ==================== SIDEBAR TOGGLE FUNCTIONALITY ====================
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            // Toggle sidebar on button click
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('active');
            });
            
            // Close sidebar when clicking on overlay
            sidebarOverlay.addEventListener('click', function() {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('active');
            });
            
            // Close sidebar when clicking on a menu item (for mobile)
            const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth < 992) {
                        sidebar.classList.remove('open');
                        sidebarOverlay.classList.remove('active');
                    }
                });
            });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 992) {
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.remove('active');
                }
            });
        });

        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyA_s-rHStZQPzuEjb_FpClS3Aaac1sidYQ",
            authDomain: "security-company-system.firebaseapp.com",
            databaseURL: "https://guard-e5328-default-rtdb.firebaseio.com",
            projectId: "security-company-system",
            storageBucket: "security-company-system.firebasestorage.app",
            messagingSenderId: "518820113373",
            appId: "1:518820113373:web:087d0b4ad1c202d590a434"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ==================== SYSTEM VARIABLES ====================
        let currentUser = null;
        let guards = [];
        let shifts = [];
        let incidents = [];
        let leaves = [];
        let currentEditingGuardId = null;
        let pendingGuardData = null;

        // ==================== PERMISSION FUNCTIONS ====================
        function hasPermission(action, section) {
            if (!currentUser) return false;
            
            // Admin has all permissions
            if (currentUser.role === 'admin') return true;
            
            // Manager permissions
            if (currentUser.role === 'manager') {
                const managerPermissions = {
                    'guards': ['view', 'edit'],
                    'shifts': ['view', 'create', 'edit', 'delete'],
                    'incidents': ['view', 'create', 'edit', 'delete'],
                    'leaves': ['view', 'create', 'edit', 'delete', 'approve'],
                    'reports': ['view']
                };
                return managerPermissions[section]?.includes(action) || false;
            }
            
            // Guard permissions
            if (currentUser.role === 'guard') {
                const guardPermissions = {
                    'guards': ['view_own_profile'],
                    'shifts': ['view'],
                    'incidents': ['view'],
                    'leaves': ['view'],
                    'reports': ['view']
                };
                return guardPermissions[section]?.includes(action) || false;
            }
            
            return false;
        }

        function setupPermissions() {
            const userRole = currentUser.role;
            
            // Hide/show add buttons based on permissions
            document.getElementById('addGuardBtn').style.display = 
                hasPermission('create', 'guards') ? 'block' : 'none';
            document.getElementById('addShiftBtn').style.display = 
                hasPermission('create', 'shifts') ? 'block' : 'none';
            document.getElementById('addIncidentBtn').style.display = 
                hasPermission('create', 'incidents') ? 'block' : 'none';
            document.getElementById('addLeaveBtn').style.display = 
                hasPermission('create', 'leaves') ? 'block' : 'none';
            
            // Setup guard view based on role
            if (userRole === 'guard') {
                document.getElementById('adminGuardView').style.display = 'none';
                document.getElementById('guardProfileView').style.display = 'block';
                loadGuardProfile();
            } else {
                document.getElementById('adminGuardView').style.display = 'block';
                document.getElementById('guardProfileView').style.display = 'none';
            }
        }

        // ==================== IMAGE HANDLING FUNCTIONS ====================
        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Validate file size (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert('حجم فایل باید کمتر از 2MB باشد');
                    input.value = '';
                    preview.style.display = 'none';
                    return;
                }
                
                // Validate file type
                if (!file.type.match('image/jpeg') && !file.type.match('image/png')) {
                    alert('فقط فایل‌های JPG و PNG مجاز هستند');
                    input.value = '';
                    preview.style.display = 'none';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        }

        function previewEditImage(input) {
            const preview = document.getElementById('editImagePreview');
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Validate file size (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert('حجم فایل باید کمتر از 2MB باشد');
                    input.value = '';
                    preview.style.display = 'none';
                    return;
                }
                
                // Validate file type
                if (!file.type.match('image/jpeg') && !file.type.match('image/png')) {
                    alert('فقط فایل‌های JPG و PNG مجاز هستند');
                    input.value = '';
                    preview.style.display = 'none';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        }

        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                reader.onerror = function(error) {
                    reject(error);
                };
                reader.readAsDataURL(file);
            });
        }

        // ==================== INITIAL SETUP ====================
        async function createDefaultAdmin() {
            try {
                const adminData = {
                    phone: "0780060833",
                    password: "admin123",
                    role: "admin",
                    firstName: "ذبیح الله",
                    lastName: "کاکر",
                    status: "active",
                    createdAt: new Date().toISOString()
                };
                
                const usersRef = database.ref('users');
                const snapshot = await usersRef.once('value');
                
                let adminExists = false;
                let adminKey = null;
                
                snapshot.forEach((child) => {
                    const user = child.val();
                    if (user.phone === "0780060833") {
                        adminExists = true;
                        adminKey = child.key;
                    }
                });
                
                if (adminExists && adminKey) {
                    await usersRef.child(adminKey).set(adminData);
                } else {
                    await usersRef.push(adminData);
                }
                
            } catch (error) {
                console.error("Error creating admin:", error);
            }
        }

        // ==================== LOGIN SYSTEM ====================
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            try {
                const usersRef = database.ref('users');
                const snapshot = await usersRef.once('value');
                
                let userFound = null;
                let userId = null;
                
                snapshot.forEach((child) => {
                    const user = child.val();
                    if (user.phone === phone && user.password === password) {
                        userFound = user;
                        userId = child.key;
                    }
                });
                
                if (userFound) {
                    currentUser = { id: userId, ...userFound };
                    
                    showMainSystem();
                    setupUserInterface();
                    setupPermissions();
                    loadAllData();
                } else {
                    throw new Error('شماره تماس یا رمز عبور اشتباه است');
                }
                
            } catch (error) {
                alert(error.message);
            }
        });

        function showMainSystem() {
            document.getElementById('loginSystem').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'block';
            document.body.classList.add('main-system-active');
        }

        function showLoginSystem() {
            document.getElementById('loginSystem').style.display = 'flex';
            document.getElementById('mainSystem').style.display = 'none';
            document.body.classList.remove('main-system-active');
            currentUser = null;
        }

        function setupUserInterface() {
            document.getElementById('userWelcome').textContent = `خوش آمدید، ${currentUser.firstName}`;
            document.getElementById('userBadge').textContent = getRoleText(currentUser.role);
            document.getElementById('userBadge').className = `user-badge role-${currentUser.role}`;
        }

        function getRoleText(role) {
            const roles = {
                'admin': 'مدیر سیستم',
                'manager': 'مدیر',
                'guard': 'محافظ'
            };
            return roles[role] || role;
        }

        function logout() {
            if (confirm('آیا از سیستم خارج می‌شوید؟')) {
                showLoginSystem();
            }
        }

        // ==================== DATA MANAGEMENT ====================
        function loadAllData() {
            loadGuards();
            loadShifts();
            loadIncidents();
            loadLeaves();
        }

        function loadGuards() {
            database.ref('guards').on('value', (snapshot) => {
                guards = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        guards.push({
                            id: child.key,
                            ...child.val()
                        });
                    });
                }
                loadGuardsList();
                populateGuardDropdowns();
                updateReports();
                
                // اگر کاربر محافظ است، پروفایل خودش را بارگذاری کن
                if (currentUser.role === 'guard') {
                    loadGuardProfile();
                }
            });
        }

        function loadShifts() {
            database.ref('shifts').on('value', (snapshot) => {
                shifts = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        shifts.push({
                            id: child.key,
                            ...child.val()
                        });
                    });
                }
                loadShiftsList();
                updateReports();
            });
        }

        function loadIncidents() {
            database.ref('incidents').on('value', (snapshot) => {
                incidents = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        incidents.push({
                            id: child.key,
                            ...child.val()
                        });
                    });
                }
                loadIncidentsList();
                updateReports();
            });
        }

        function loadLeaves() {
            database.ref('leaves').on('value', (snapshot) => {
                leaves = [];
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        leaves.push({
                            id: child.key,
                            ...child.val()
                        });
                    });
                }
                loadLeavesList();
                updateReports();
            });
        }

        // ==================== GUARD MANAGEMENT ====================
        document.getElementById('guardForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Check permission
            if (!hasPermission('create', 'guards')) {
                alert('شما دسترسی لازم برای افزودن محافظ جدید را ندارید');
                return;
            }
            
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const fatherName = document.getElementById('fatherName').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const password = document.getElementById('guardPassword').value;
            const country = document.getElementById('country').value;
            const province = document.getElementById('province').value;
            const district = document.getElementById('district').value;
            const position = document.getElementById('position').value;
            const guardCategory = document.getElementById('guardCategory').value;
            const userRole = document.getElementById('userRole').value;
            const hireDate = document.getElementById('hireDate').value;
            const profilePhoto = document.getElementById('profilePhoto').files[0];

            try {
                // Check if phone exists
                const usersSnapshot = await database.ref('users').once('value');
                let phoneExists = false;
                
                usersSnapshot.forEach((child) => {
                    const user = child.val();
                    if (user.phone === phoneNumber) {
                        phoneExists = true;
                    }
                });
                
                if (phoneExists) {
                    // Show duplicate phone modal
                    document.getElementById('duplicatePhoneNumber').textContent = phoneNumber;
                    pendingGuardData = {
                        firstName, lastName, fatherName, phoneNumber, password,
                        country, province, district, position, guardCategory, userRole, hireDate, profilePhoto
                    };
                    
                    const modal = new bootstrap.Modal(document.getElementById('duplicatePhoneModal'));
                    modal.show();
                    return;
                }

                await createGuardAccount({
                    firstName, lastName, fatherName, phoneNumber, password,
                    country, province, district, position, guardCategory, userRole, hireDate, profilePhoto
                });

            } catch (error) {
                alert('خطا در ثبت: ' + error.message);
            }
        });

        // Handle duplicate phone confirmation
        document.getElementById('confirmDuplicate').addEventListener('click', async function() {
            if (pendingGuardData) {
                await createGuardAccount(pendingGuardData);
                const modal = bootstrap.Modal.getInstance(document.getElementById('duplicatePhoneModal'));
                modal.hide();
                pendingGuardData = null;
            }
        });

        async function createGuardAccount(guardData) {
            const { firstName, lastName, fatherName, phoneNumber, password,
                    country, province, district, position, guardCategory, userRole, hireDate, profilePhoto } = guardData;

            try {
                let photoData = '';
                // Convert image to base64 if exists
                if (profilePhoto) {
                    photoData = await convertImageToBase64(profilePhoto);
                }

                // Create guard data
                const guardData = {
                    firstName: firstName,
                    lastName: lastName,
                    fatherName: fatherName,
                    phoneNumber: phoneNumber,
                    country: country,
                    province: province,
                    district: district,
                    position: position,
                    guardCategory: guardCategory,
                    role: userRole,
                    hireDate: hireDate,
                    photoData: photoData,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.id
                };

                // Create user account
                const userData = {
                    phone: phoneNumber,
                    password: password,
                    role: userRole,
                    firstName: firstName,
                    lastName: lastName,
                    position: position,
                    guardCategory: guardCategory,
                    status: 'active',
                    photoData: photoData,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.id
                };

                await database.ref('guards').push(guardData);
                await database.ref('users').push(userData);

                document.getElementById('guardForm').reset();
                document.getElementById('imagePreview').style.display = 'none';
                hideAddGuardForm();
                showSaveIndicator();
                
                alert(`✅ ${userRole === 'manager' ? 'مدیر' : 'محافظ'} جدید ثبت شد!\n\nشماره: ${phoneNumber}\nرمز: ${password}`);

            } catch (error) {
                alert('خطا در ثبت: ' + error.message);
            }
        }

        // DELETE GUARD FUNCTION - COMPLETELY REMOVES FROM ALL DATABASES
        async function deleteGuard(guardId, phoneNumber) {
            if (!hasPermission('delete', 'guards')) {
                alert('شما دسترسی لازم برای حذف محافظ را ندارید');
                return;
            }

            if (!confirm(`آیا از حذف محافظ با شماره ${phoneNumber} مطمئن هستید؟\nاین عمل غیرقابل بازگشت است!`)) {
                return;
            }

            try {
                // Delete from guards database
                await database.ref('guards/' + guardId).remove();

                // Delete from users database
                const usersSnapshot = await database.ref('users').once('value');
                usersSnapshot.forEach((child) => {
                    const user = child.val();
                    if (user.phone === phoneNumber) {
                        database.ref('users/' + child.key).remove();
                    }
                });

                // Delete related shifts
                const shiftsSnapshot = await database.ref('shifts').once('value');
                shiftsSnapshot.forEach((child) => {
                    const shift = child.val();
                    if (shift.guardId === guardId) {
                        database.ref('shifts/' + child.key).remove();
                    }
                });

                // Delete related incidents
                const incidentsSnapshot = await database.ref('incidents').once('value');
                incidentsSnapshot.forEach((child) => {
                    const incident = child.val();
                    if (incident.guardId === guardId) {
                        database.ref('incidents/' + child.key).remove();
                    }
                });

                // Delete related leaves
                const leavesSnapshot = await database.ref('leaves').once('value');
                leavesSnapshot.forEach((child) => {
                    const leave = child.val();
                    if (leave.guardId === guardId) {
                        database.ref('leaves/' + child.key).remove();
                    }
                });

                showSaveIndicator();
                alert('✅ محافظ و تمام اطلاعات مرتبط با موفقیت حذف شد!');

            } catch (error) {
                alert('خطا در حذف: ' + error.message);
            }
        }

        function loadGuardsList() {
            const container = document.getElementById('guardsList');
            const searchTerm = document.getElementById('searchGuards').value.toLowerCase();
            const roleFilter = document.getElementById('filterRole').value;
            const categoryFilter = document.getElementById('filterGuardCategory').value;

            container.innerHTML = '';

            let filteredGuards = guards;

            // Apply filters
            if (searchTerm) {
                filteredGuards = filteredGuards.filter(guard => 
                    guard.firstName.toLowerCase().includes(searchTerm) ||
                    guard.lastName.toLowerCase().includes(searchTerm) ||
                    guard.phoneNumber.includes(searchTerm)
                );
            }

            if (roleFilter) {
                filteredGuards = filteredGuards.filter(guard => guard.role === roleFilter);
            }

            if (categoryFilter) {
                filteredGuards = filteredGuards.filter(guard => guard.guardCategory === categoryFilter);
            }

            if (filteredGuards.length === 0) {
                container.innerHTML = '<div class="alert alert-info">هیچ محافظی مطابق با فیلترها یافت نشد</div>';
                return;
            }

            filteredGuards.forEach(guard => {
                const positionText = getPositionText(guard.position);
                const serviceYears = calculateServiceYears(guard.hireDate);
                const categoryText = getGuardCategoryText(guard.guardCategory);

                const guardItem = document.createElement('div');
                guardItem.className = 'guard-item';
                guardItem.onclick = () => showGuardDetails(guard.id);
                guardItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            ${guard.photoData ? 
                                `<img src="${guard.photoData}" class="profile-photo" alt="${guard.firstName} ${guard.lastName}">` :
                                `<div class="profile-photo bg-light d-flex align-items-center justify-content-center">
                                    <i class="fas fa-user text-muted"></i>
                                </div>`
                            }
                            <div class="ms-3">
                                <h6 class="mb-1">${guard.firstName} ${guard.lastName}</h6>
                                <small class="text-muted">📞 ${guard.phoneNumber} | 📅 ${guard.hireDate}</small>
                                <br>
                                <span class="badge bg-primary">${positionText}</span>
                                <span class="badge bg-secondary">${serviceYears} سال خدمت</span>
                                <span class="badge ${guard.role === 'manager' ? 'bg-warning' : 'bg-info'}">${getRoleText(guard.role)}</span>
                                <span class="badge ${guard.guardCategory === 'mobile' ? 'bg-success' : 'bg-primary'}">${categoryText}</span>
                            </div>
                        </div>
                        <div>
                            ${hasPermission('delete', 'guards') ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteGuard('${guard.id}', '${guard.phoneNumber}')">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            ` : ''}
                            ${hasPermission('edit', 'guards') ? `
                                <button class="btn btn-sm btn-outline-warning" onclick="event.stopPropagation(); editGuard('${guard.id}')">
                                    <i class="fas fa-edit"></i> ویرایش
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showGuardDetails('${guard.id}')">
                                <i class="fas fa-eye"></i> مشاهده
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(guardItem);
            });
        }

        // FIXED: Edit guard function
        function editGuard(guardId) {
            if (!hasPermission('edit', 'guards')) {
                alert('شما دسترسی لازم برای ویرایش محافظ را ندارید');
                return;
            }

            currentEditingGuardId = guardId;
            const guard = guards.find(g => g.id === guardId);
            if (!guard) return;

            // پر کردن فرم ویرایش با اطلاعات فعلی
            document.getElementById('editGuardId').value = guardId;
            document.getElementById('editFirstName').value = guard.firstName;
            document.getElementById('editLastName').value = guard.lastName;
            document.getElementById('editFatherName').value = guard.fatherName;
            document.getElementById('editPhoneNumber').value = guard.phoneNumber;
            document.getElementById('editCountry').value = guard.country || 'افغانستان';
            document.getElementById('editProvince').value = guard.province || '';
            document.getElementById('editDistrict').value = guard.district || '';
            document.getElementById('editPosition').value = guard.position;
            document.getElementById('editGuardCategory').value = guard.guardCategory || 'mobile';
            document.getElementById('editUserRole').value = guard.role;
            document.getElementById('editHireDate').value = guard.hireDate;

            // نمایش عکس فعلی اگر وجود دارد
            if (guard.photoData) {
                document.getElementById('editImagePreview').src = guard.photoData;
                document.getElementById('editImagePreview').style.display = 'block';
            } else {
                document.getElementById('editImagePreview').style.display = 'none';
            }

            const editModal = new bootstrap.Modal(document.getElementById('editGuardModal'));
            editModal.show();
        }

        // FIXED: Update guard function
        async function updateGuard() {
            const guardId = document.getElementById('editGuardId').value;
            const firstName = document.getElementById('editFirstName').value;
            const lastName = document.getElementById('editLastName').value;
            const fatherName = document.getElementById('editFatherName').value;
            const phoneNumber = document.getElementById('editPhoneNumber').value;
            const password = document.getElementById('editPassword').value;
            const country = document.getElementById('editCountry').value;
            const province = document.getElementById('editProvince').value;
            const district = document.getElementById('editDistrict').value;
            const position = document.getElementById('editPosition').value;
            const guardCategory = document.getElementById('editGuardCategory').value;
            const userRole = document.getElementById('editUserRole').value;
            const hireDate = document.getElementById('editHireDate').value;
            const profilePhoto = document.getElementById('editProfilePhoto').files[0];

            try {
                let photoData = null;
                // Convert new image to base64 if exists
                if (profilePhoto) {
                    photoData = await convertImageToBase64(profilePhoto);
                }

                // Update guard data
                const guardData = {
                    firstName: firstName,
                    lastName: lastName,
                    fatherName: fatherName,
                    phoneNumber: phoneNumber,
                    country: country,
                    province: province,
                    district: district,
                    position: position,
                    guardCategory: guardCategory,
                    role: userRole,
                    hireDate: hireDate,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.id
                };

                // Add photo data if new photo was uploaded
                if (photoData) {
                    guardData.photoData = photoData;
                }

                await database.ref('guards/' + guardId).update(guardData);

                // Update user data
                const userData = {
                    phone: phoneNumber,
                    role: userRole,
                    firstName: firstName,
                    lastName: lastName,
                    position: position,
                    guardCategory: guardCategory,
                    updatedAt: new Date().toISOString()
                };

                // Add password if changed
                if (password) {
                    userData.password = password;
                }

                // Add photo data if new photo was uploaded
                if (photoData) {
                    userData.photoData = photoData;
                }

                // Find and update user record
                const usersSnapshot = await database.ref('users').once('value');
                usersSnapshot.forEach((child) => {
                    const user = child.val();
                    if (user.phone === phoneNumber) {
                        database.ref('users/' + child.key).update(userData);
                    }
                });

                const editModal = bootstrap.Modal.getInstance(document.getElementById('editGuardModal'));
                editModal.hide();

                showSaveIndicator();
                alert('✅ اطلاعات محافظ با موفقیت به‌روزرسانی شد!');

            } catch (error) {
                alert('خطا در به‌روزرسانی: ' + error.message);
            }
        }

        // FIXED: Show guard details function
        function showGuardDetails(guardId) {
            const guard = guards.find(g => g.id === guardId);
            if (!guard) return;

            const positionText = getPositionText(guard.position);
            const serviceYears = calculateServiceYears(guard.hireDate);
            const categoryText = getGuardCategoryText(guard.guardCategory);

            const modalContent = `
                <div class="row">
                    <div class="col-md-4 text-center">
                        ${guard.photoData ? 
                            `<img src="${guard.photoData}" class="profile-photo-large" alt="${guard.firstName} ${guard.lastName}">` :
                            `<div class="profile-photo-placeholder">
                                <i class="fas fa-user"></i>
                            </div>`
                        }
                        <h4 class="mt-3">${guard.firstName} ${guard.lastName}</h4>
                        <span class="badge bg-primary fs-6">${positionText}</span>
                        <span class="badge ${guard.guardCategory === 'mobile' ? 'bg-success' : 'bg-primary'} mt-1">${categoryText}</span>
                    </div>
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">مشخصات شخصی</h5>
                            </div>
                            <div class="col-md-6">
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">نام کامل:</span>
                                    ${guard.firstName} ${guard.lastName}
                                </div>
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">نام پدر:</span>
                                    ${guard.fatherName}
                                </div>
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">شماره تماس:</span>
                                    ${guard.phoneNumber}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">کشور:</span>
                                    ${guard.country || 'ثبت نشده'}
                                </div>
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">ولایت:</span>
                                    ${guard.province || 'ثبت نشده'}
                                </div>
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">ولسوالی:</span>
                                    ${guard.district || 'ثبت نشده'}
                                </div>
                            </div>
                            
                            <div class="col-12 mt-3">
                                <h5 class="border-bottom pb-2">مشخصات کاری</h5>
                            </div>
                            <div class="col-md-6">
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">تاریخ استخدام:</span>
                                    ${guard.hireDate}
                                </div>
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">مدت خدمت:</span>
                                    ${serviceYears} سال
                                </div>
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">دسته:</span>
                                    ${categoryText}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">نقش:</span>
                                    <span class="badge ${guard.role === 'manager' ? 'bg-warning' : 'bg-info'}">
                                        ${getRoleText(guard.role)}
                                    </span>
                                </div>
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">رتبه:</span>
                                    <span class="badge bg-primary">${positionText}</span>
                                </div>
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">وضعیت:</span>
                                    <span class="badge bg-success">فعال</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('guardDetailContent').innerHTML = modalContent;
            document.getElementById('guardDetailModalLabel').textContent = `جزئیات ${guard.firstName} ${guard.lastName}`;
            
            // نمایش دکمه ویرایش فقط برای کاربران مجاز
            if (hasPermission('edit', 'guards')) {
                document.getElementById('editGuardBtn').style.display = 'block';
                currentEditingGuardId = guardId;
            } else {
                document.getElementById('editGuardBtn').style.display = 'none';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('guardDetailModal'));
            modal.show();
        }

        function searchGuards() {
            loadGuardsList();
        }

        function filterGuards() {
            loadGuardsList();
        }

        // ==================== SHIFT MANAGEMENT ====================
        function showAddShiftForm() {
            if (!hasPermission('create', 'shifts')) {
                alert('شما دسترسی لازم برای افزودن شیفت را ندارید');
                return;
            }
            document.getElementById('addShiftForm').style.display = 'block';
        }

        function hideAddShiftForm() {
            document.getElementById('addShiftForm').style.display = 'none';
            document.getElementById('shiftForm').reset();
        }

        document.getElementById('shiftForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!hasPermission('create', 'shifts')) {
                alert('شما دسترسی لازم برای افزودن شیفت را ندارید');
                return;
            }
            
            const guardId = document.getElementById('shiftGuardId').value;
            const shiftType = document.getElementById('shiftType').value;
            const shiftDate = document.getElementById('shiftDate').value;
            const shiftLocation = document.getElementById('shiftLocation').value;
            const shiftDescription = document.getElementById('shiftDescription').value;

            try {
                const shiftData = {
                    guardId: guardId,
                    shiftType: shiftType,
                    shiftDate: shiftDate,
                    location: shiftLocation,
                    description: shiftDescription,
                    status: 'Scheduled',
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.id
                };

                await database.ref('shifts').push(shiftData);

                document.getElementById('shiftForm').reset();
                hideAddShiftForm();
                showSaveIndicator();
                
                alert('✅ شیفت جدید با موفقیت ثبت شد!');

            } catch (error) {
                alert('خطا در ثبت شیفت: ' + error.message);
            }
        });

        function loadShiftsList() {
            const container = document.getElementById('shiftsList');
            const searchTerm = document.getElementById('searchShifts').value.toLowerCase();
            const typeFilter = document.getElementById('filterShiftType').value;
            const dateFilter = document.getElementById('filterShiftDate').value;

            container.innerHTML = '';

            let filteredShifts = shifts;

            // Apply filters
            if (searchTerm) {
                filteredShifts = filteredShifts.filter(shift => {
                    const guard = guards.find(g => g.id === shift.guardId);
                    return guard && (
                        guard.firstName.toLowerCase().includes(searchTerm) ||
                        guard.lastName.toLowerCase().includes(searchTerm)
                    );
                });
            }

            if (typeFilter) {
                filteredShifts = filteredShifts.filter(shift => shift.shiftType === typeFilter);
            }

            if (dateFilter) {
                filteredShifts = filteredShifts.filter(shift => shift.shiftDate === dateFilter);
            }

            if (filteredShifts.length === 0) {
                container.innerHTML = '<div class="alert alert-info">هیچ شیفتی مطابق با فیلترها یافت نشد</div>';
                return;
            }

            filteredShifts.forEach(shift => {
                const guard = guards.find(g => g.id === shift.guardId);
                if (!guard) return;

                const shiftTypeText = getShiftTypeText(shift.shiftType);
                const shiftTypeClass = getShiftTypeClass(shift.shiftType);

                const shiftItem = document.createElement('div');
                shiftItem.className = 'shift-item';
                shiftItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            ${guard.photoData ? 
                                `<img src="${guard.photoData}" class="profile-photo" alt="${guard.firstName} ${guard.lastName}">` :
                                `<div class="profile-photo bg-light d-flex align-items-center justify-content-center">
                                    <i class="fas fa-user text-muted"></i>
                                </div>`
                            }
                            <div class="ms-3">
                                <h6 class="mb-1">${guard.firstName} ${guard.lastName}</h6>
                                <small class="text-muted">📅 ${shift.shiftDate} | 📍 ${shift.location}</small>
                                <br>
                                <span class="badge ${shiftTypeClass}">${shiftTypeText}</span>
                                <span class="badge bg-info">${getStatusText(shift.status)}</span>
                            </div>
                        </div>
                        <div>
                            ${hasPermission('edit', 'shifts') ? `
                                <button class="btn btn-sm btn-outline-warning" onclick="editShift('${shift.id}')">
                                    <i class="fas fa-edit"></i> ویرایش
                                </button>
                            ` : ''}
                            ${hasPermission('delete', 'shifts') ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteShift('${shift.id}')">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    ${shift.description ? `<p class="mt-2 mb-0"><small>${shift.description}</small></p>` : ''}
                `;
                container.appendChild(shiftItem);
            });
        }

        function filterShifts() {
            loadShiftsList();
        }

        function clearShiftFilters() {
            document.getElementById('searchShifts').value = '';
            document.getElementById('filterShiftType').value = '';
            document.getElementById('filterShiftDate').value = '';
            loadShiftsList();
        }

        async function deleteShift(shiftId) {
            if (!hasPermission('delete', 'shifts')) {
                alert('شما دسترسی لازم برای حذف شیفت را ندارید');
                return;
            }

            if (!confirm('آیا از حذف این شیفت مطمئن هستید؟')) {
                return;
            }

            try {
                await database.ref('shifts/' + shiftId).remove();
                showSaveIndicator();
                alert('✅ شیفت با موفقیت حذف شد!');
            } catch (error) {
                alert('خطا در حذف شیفت: ' + error.message);
            }
        }

        // ==================== INCIDENT MANAGEMENT ====================
        function showAddIncidentForm() {
            if (!hasPermission('create', 'incidents')) {
                alert('شما دسترسی لازم برای افزودن گزارش حادثه را ندارید');
                return;
            }
            document.getElementById('addIncidentForm').style.display = 'block';
        }

        function hideAddIncidentForm() {
            document.getElementById('addIncidentForm').style.display = 'none';
            document.getElementById('incidentForm').reset();
        }

        document.getElementById('incidentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!hasPermission('create', 'incidents')) {
                alert('شما دسترسی لازم برای افزودن گزارش حادثه را ندارید');
                return;
            }
            
            const guardId = document.getElementById('incidentGuardId').value;
            const title = document.getElementById('incidentTitle').value;
            const incidentDate = document.getElementById('incidentDate').value;
            const location = document.getElementById('incidentLocation').value;
            const severity = document.getElementById('incidentSeverity').value;
            const description = document.getElementById('incidentDescription').value;
            const actions = document.getElementById('incidentActions').value;

            try {
                const incidentData = {
                    guardId: guardId,
                    title: title,
                    incidentDate: incidentDate,
                    location: location,
                    severity: severity,
                    description: description,
                    actionsTaken: actions,
                    status: 'Reported',
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.id
                };

                await database.ref('incidents').push(incidentData);

                document.getElementById('incidentForm').reset();
                hideAddIncidentForm();
                showSaveIndicator();
                
                alert('✅ حادثه جدید با موفقیت گزارش شد!');

            } catch (error) {
                alert('خطا در ثبت حادثه: ' + error.message);
            }
        });

        function loadIncidentsList() {
            const container = document.getElementById('incidentsList');
            const searchTerm = document.getElementById('searchIncidents').value.toLowerCase();
            const severityFilter = document.getElementById('filterSeverity').value;
            const statusFilter = document.getElementById('filterStatus').value;

            container.innerHTML = '';

            let filteredIncidents = incidents;

            // Apply filters
            if (searchTerm) {
                filteredIncidents = filteredIncidents.filter(incident => {
                    const guard = guards.find(g => g.id === incident.guardId);
                    return incident.title.toLowerCase().includes(searchTerm) ||
                           (guard && guard.firstName.toLowerCase().includes(searchTerm)) ||
                           (guard && guard.lastName.toLowerCase().includes(searchTerm));
                });
            }

            if (severityFilter) {
                filteredIncidents = filteredIncidents.filter(incident => incident.severity === severityFilter);
            }

            if (statusFilter) {
                filteredIncidents = filteredIncidents.filter(incident => incident.status === statusFilter);
            }

            if (filteredIncidents.length === 0) {
                container.innerHTML = '<div class="alert alert-info">هیچ حادثه‌ای مطابق با فیلترها یافت نشد</div>';
                return;
            }

            filteredIncidents.forEach(incident => {
                const guard = guards.find(g => g.id === incident.guardId);
                if (!guard) return;

                const incidentItem = document.createElement('div');
                incidentItem.className = 'incident-item';
                incidentItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="d-flex align-items-start">
                            ${guard.photoData ? 
                                `<img src="${guard.photoData}" class="profile-photo" alt="${guard.firstName} ${guard.lastName}">` :
                                `<div class="profile-photo bg-light d-flex align-items-center justify-content-center">
                                    <i class="fas fa-user text-muted"></i>
                                </div>`
                            }
                            <div class="ms-3">
                                <h6 class="mb-1">${incident.title}</h6>
                                <small class="text-muted">👤 ${guard.firstName} ${guard.lastName} | 📅 ${incident.incidentDate} | 📍 ${incident.location}</small>
                                <p class="mb-2 mt-2">${incident.description}</p>
                                ${incident.actionsTaken ? `<p class="mb-2"><strong>اقدامات:</strong> ${incident.actionsTaken}</p>` : ''}
                                <span class="badge severity-${incident.severity.toLowerCase()}">${getSeverityText(incident.severity)}</span>
                                <span class="badge bg-info">${getStatusText(incident.status)}</span>
                            </div>
                        </div>
                        <div>
                            ${hasPermission('edit', 'incidents') ? `
                                <button class="btn btn-sm btn-outline-warning" onclick="editIncident('${incident.id}')">
                                    <i class="fas fa-edit"></i> ویرایش
                                </button>
                            ` : ''}
                            ${hasPermission('delete', 'incidents') ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteIncident('${incident.id}')">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(incidentItem);
            });
        }

        function filterIncidents() {
            loadIncidentsList();
        }

        function clearIncidentFilters() {
            document.getElementById('searchIncidents').value = '';
            document.getElementById('filterSeverity').value = '';
            document.getElementById('filterStatus').value = '';
            loadIncidentsList();
        }

        async function deleteIncident(incidentId) {
            if (!hasPermission('delete', 'incidents')) {
                alert('شما دسترسی لازم برای حذف گزارش حادثه را ندارید');
                return;
            }

            if (!confirm('آیا از حذف این گزارش حادثه مطمئن هستید؟')) {
                return;
            }

            try {
                await database.ref('incidents/' + incidentId).remove();
                showSaveIndicator();
                alert('✅ گزارش حادثه با موفقیت حذف شد!');
            } catch (error) {
                alert('خطا در حذف گزارش: ' + error.message);
            }
        }

        // ==================== LEAVE MANAGEMENT ====================
        function showAddLeaveForm() {
            if (!hasPermission('create', 'leaves')) {
                alert('شما دسترسی لازم برای افزودن درخواست مرخصی را ندارید');
                return;
            }
            document.getElementById('addLeaveForm').style.display = 'block';
        }

        function hideAddLeaveForm() {
            document.getElementById('addLeaveForm').style.display = 'none';
            document.getElementById('leaveForm').reset();
        }

        document.getElementById('leaveForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!hasPermission('create', 'leaves')) {
                alert('شما دسترسی لازم برای افزودن درخواست مرخصی را ندارید');
                return;
            }
            
            const guardId = document.getElementById('leaveGuardId').value;
            const leaveType = document.getElementById('leaveType').value;
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;
            const reason = document.getElementById('leaveReason').value;

            try {
                const leaveData = {
                    guardId: guardId,
                    leaveType: leaveType,
                    startDate: startDate,
                    endDate: endDate,
                    reason: reason,
                    status: 'Pending',
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.id
                };

                await database.ref('leaves').push(leaveData);

                document.getElementById('leaveForm').reset();
                hideAddLeaveForm();
                showSaveIndicator();
                
                alert('✅ درخواست مرخصی با موفقیت ثبت شد!');

            } catch (error) {
                alert('خطا در ثبت درخواست مرخصی: ' + error.message);
            }
        });

        function loadLeavesList() {
            const container = document.getElementById('leavesList');
            const searchTerm = document.getElementById('searchLeaves').value.toLowerCase();
            const typeFilter = document.getElementById('filterLeaveType').value;
            const statusFilter = document.getElementById('filterLeaveStatus').value;

            container.innerHTML = '';

            let filteredLeaves = leaves;

            // Apply filters
            if (searchTerm) {
                filteredLeaves = filteredLeaves.filter(leave => {
                    const guard = guards.find(g => g.id === leave.guardId);
                    return guard && (
                        guard.firstName.toLowerCase().includes(searchTerm) ||
                        guard.lastName.toLowerCase().includes(searchTerm)
                    );
                });
            }

            if (typeFilter) {
                filteredLeaves = filteredLeaves.filter(leave => leave.leaveType === typeFilter);
            }

            if (statusFilter) {
                filteredLeaves = filteredLeaves.filter(leave => leave.status === statusFilter);
            }

            if (filteredLeaves.length === 0) {
                container.innerHTML = '<div class="alert alert-info">هیچ درخواست مرخصی مطابق با فیلترها یافت نشد</div>';
                return;
            }

            filteredLeaves.forEach(leave => {
                const guard = guards.find(g => g.id === leave.guardId);
                if (!guard) return;

                const leaveItem = document.createElement('div');
                leaveItem.className = 'leave-item';
                leaveItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            ${guard.photoData ? 
                                `<img src="${guard.photoData}" class="profile-photo" alt="${guard.firstName} ${guard.lastName}">` :
                                `<div class="profile-photo bg-light d-flex align-items-center justify-content-center">
                                    <i class="fas fa-user text-muted"></i>
                                </div>`
                            }
                            <div class="ms-3">
                                <h6 class="mb-1">${guard.firstName} ${guard.lastName}</h6>
                                <small class="text-muted">📅 ${leave.startDate} تا ${leave.endDate}</small>
                                <br>
                                <span class="badge bg-info">${getLeaveTypeText(leave.leaveType)}</span>
                                <span class="badge status-${leave.status.toLowerCase()}">${getStatusText(leave.status)}</span>
                                ${leave.reason ? `<p class="mb-0 mt-1"><small>دلیل: ${leave.reason}</small></p>` : ''}
                            </div>
                        </div>
                        <div>
                            ${hasPermission('approve', 'leaves') && leave.status === 'Pending' ? `
                                <button class="btn btn-sm btn-success" onclick="approveLeave('${leave.id}')">
                                    <i class="fas fa-check"></i> تایید
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="rejectLeave('${leave.id}')">
                                    <i class="fas fa-times"></i> رد
                                </button>
                            ` : ''}
                            ${hasPermission('edit', 'leaves') ? `
                                <button class="btn btn-sm btn-outline-warning" onclick="editLeave('${leave.id}')">
                                    <i class="fas fa-edit"></i> ویرایش
                                </button>
                            ` : ''}
                            ${hasPermission('delete', 'leaves') ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteLeave('${leave.id}')">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(leaveItem);
            });
        }

        function filterLeaves() {
            loadLeavesList();
        }

        function clearLeaveFilters() {
            document.getElementById('searchLeaves').value = '';
            document.getElementById('filterLeaveType').value = '';
            document.getElementById('filterLeaveStatus').value = '';
            loadLeavesList();
        }

        async function approveLeave(leaveId) {
            if (!hasPermission('approve', 'leaves')) {
                alert('شما دسترسی لازم برای تایید مرخصی را ندارید');
                return;
            }

            try {
                await database.ref('leaves/' + leaveId).update({
                    status: 'Approved',
                    approvedBy: currentUser.id,
                    approvedAt: new Date().toISOString()
                });
                showSaveIndicator();
                alert('✅ درخواست مرخصی تایید شد!');
            } catch (error) {
                alert('خطا در تایید مرخصی: ' + error.message);
            }
        }

        async function rejectLeave(leaveId) {
            if (!hasPermission('approve', 'leaves')) {
                alert('شما دسترسی لازم برای رد مرخصی را ندارید');
                return;
            }

            try {
                await database.ref('leaves/' + leaveId).update({
                    status: 'Rejected',
                    rejectedBy: currentUser.id,
                    rejectedAt: new Date().toISOString()
                });
                showSaveIndicator();
                alert('✅ درخواست مرخصی رد شد!');
            } catch (error) {
                alert('خطا در رد مرخصی: ' + error.message);
            }
        }

        async function deleteLeave(leaveId) {
            if (!hasPermission('delete', 'leaves')) {
                alert('شما دسترسی لازم برای حذف درخواست مرخصی را ندارید');
                return;
            }

            if (!confirm('آیا از حذف این درخواست مرخصی مطمئن هستید؟')) {
                return;
            }

            try {
                await database.ref('leaves/' + leaveId).remove();
                showSaveIndicator();
                alert('✅ درخواست مرخصی با موفقیت حذف شد!');
            } catch (error) {
                alert('خطا در حذف درخواست: ' + error.message);
            }
        }

        // ==================== REPORTS AND DASHBOARD ====================
        function updateReports() {
            // Update counters
            document.getElementById('totalGuards').textContent = guards.length;
            document.getElementById('totalShifts').textContent = shifts.length;
            document.getElementById('totalIncidents').textContent = incidents.length;
            document.getElementById('pendingLeaves').textContent = leaves.filter(l => l.status === 'Pending').length;

            // Update charts
            updatePositionChart();
            updateIncidentChart();
            updateRecentActivities();
        }

        function updatePositionChart() {
            const container = document.getElementById('positionChart');
            const positionCount = {};

            guards.forEach(guard => {
                positionCount[guard.position] = (positionCount[guard.position] || 0) + 1;
            });

            let chartHTML = '';
            for (const [position, count] of Object.entries(positionCount)) {
                const percentage = (count / guards.length) * 100;
                chartHTML += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${getPositionText(position)}</span>
                        <span class="badge bg-primary">${count}</span>
                    </div>
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: ${percentage}%">
                            ${percentage.toFixed(1)}%
                        </div>
                    </div>
                `;
            }

            container.innerHTML = chartHTML || '<p class="text-muted">داده‌ای برای نمایش وجود ندارد</p>';
        }

        function updateIncidentChart() {
            const container = document.getElementById('incidentChart');
            const severityCount = {
                'Low': 0,
                'Medium': 0,
                'High': 0,
                'Critical': 0
            };

            incidents.forEach(incident => {
                if (severityCount.hasOwnProperty(incident.severity)) {
                    severityCount[incident.severity]++;
                }
            });

            let chartHTML = '';
            for (const [severity, count] of Object.entries(severityCount)) {
                const total = incidents.length;
                const percentage = total > 0 ? (count / total) * 100 : 0;
                chartHTML += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge severity-${severity.toLowerCase()}">${getSeverityText(severity)}</span>
                        <span>${count}</span>
                    </div>
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar severity-${severity.toLowerCase()}" role="progressbar" style="width: ${percentage}%">
                            ${percentage.toFixed(1)}%
                        </div>
                    </div>
                `;
            }

            container.innerHTML = chartHTML || '<p class="text-muted">داده‌ای برای نمایش وجود ندارد</p>';
        }

        function updateRecentActivities() {
            const container = document.getElementById('recentActivities');
            
            // Combine all activities
            const allActivities = [];
            
            shifts.forEach(shift => {
                const guard = guards.find(g => g.id === shift.guardId);
                if (guard) {
                    allActivities.push({
                        type: 'shift',
                        text: `شیفت جدید برای ${guard.firstName} ${guard.lastName}`,
                        date: shift.createdAt,
                        icon: 'fa-calendar-alt',
                        color: 'text-primary'
                    });
                }
            });

            incidents.forEach(incident => {
                const guard = guards.find(g => g.id === incident.guardId);
                if (guard) {
                    allActivities.push({
                        type: 'incident',
                        text: `گزارش حادثه توسط ${guard.firstName} ${guard.lastName}`,
                        date: incident.createdAt,
                        icon: 'fa-exclamation-triangle',
                        color: 'text-warning'
                    });
                }
            });

            leaves.forEach(leave => {
                const guard = guards.find(g => g.id === leave.guardId);
                if (guard) {
                    allActivities.push({
                        type: 'leave',
                        text: `درخواست مرخصی از ${guard.firstName} ${guard.lastName}`,
                        date: leave.createdAt,
                        icon: 'fa-umbrella-beach',
                        color: 'text-info'
                    });
                }
            });

            // Sort by date (newest first) and take last 10
            allActivities.sort((a, b) => new Date(b.date) - new Date(a.date));
            const recentActivities = allActivities.slice(0, 10);

            let activitiesHTML = '';
            if (recentActivities.length === 0) {
                activitiesHTML = '<p class="text-muted">هیچ فعالیتی برای نمایش وجود ندارد</p>';
            } else {
                recentActivities.forEach(activity => {
                    activitiesHTML += `
                        <div class="activity-item d-flex align-items-center">
                            <i class="fas ${activity.icon} ${activity.color} me-3"></i>
                            <div class="flex-grow-1">
                                <div>${activity.text}</div>
                                <small class="text-muted">${new Date(activity.date).toLocaleString('fa-IR')}</small>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = activitiesHTML;
        }

        // ==================== HELPER FUNCTIONS ====================
        function populateGuardDropdowns() {
            const guardDropdowns = [
                'shiftGuardId', 'incidentGuardId', 'leaveGuardId'
            ];

            guardDropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    // Clear existing options except the first one
                    while (dropdown.options.length > 1) {
                        dropdown.remove(1);
                    }

                    // Add guard options
                    guards.forEach(guard => {
                        const option = document.createElement('option');
                        option.value = guard.id;
                        option.textContent = `${guard.firstName} ${guard.lastName} - ${guard.phoneNumber}`;
                        dropdown.appendChild(option);
                    });
                }
            });
        }

        function getGuardCategoryText(category) {
            const categories = {
                'mobile': 'محافظ موبایل (اسکورت)',
                'office': 'محافظ دفتر (جستجو، نظارت، پذیرش)'
            };
            return categories[category] || category;
        }

        function getShiftTypeText(shiftType) {
            const types = {
                'day': 'شیفت روز',
                'night': 'شیفت شب',
                'scorting': 'شیفت اسکورت',
                'scorting-money-vip': 'اسکورت پول و افراد VIP'
            };
            return types[shiftType] || shiftType;
        }

        function getShiftTypeClass(shiftType) {
            const classes = {
                'day': 'day-shift',
                'night': 'night-shift',
                'scorting': 'scorting-shift',
                'scorting-money-vip': 'scorting-money-vip-shift'
            };
            return classes[shiftType] || 'bg-secondary';
        }

        function getPositionText(position) {
            const positions = {
                'Officer': 'افسر',
                'Second_Lieutenant': 'ساتنمن',
                'First_Lieutenant': 'لومړی ساتنمن', 
                'Guard': 'ګارد'
            };
            return positions[position] || position;
        }

        function getSeverityText(severity) {
            const severities = {
                'Low': 'کم',
                'Medium': 'متوسط',
                'High': 'زیاد',
                'Critical': 'بحرانی'
            };
            return severities[severity] || severity;
        }

        function getStatusText(status) {
            const statuses = {
                'Pending': 'در انتظار',
                'Approved': 'تایید شده',
                'Rejected': 'رد شده',
                'Reported': 'گزارش شده',
                'Scheduled': 'برنامه‌ریزی شده'
            };
            return statuses[status] || status;
        }

        function getLeaveTypeText(type) {
            const types = {
                'Annual': 'مرخصی روزانه',
                'Sick': 'مرخصی مریضی',
                'Emergency': 'مرخصی اضطراری',
                'Maternity': 'مرخصی زایمان'
            };
            return types[type] || type;
        }

        function calculateServiceYears(hireDate) {
            const hire = new Date(hireDate);
            const now = new Date();
            const years = now.getFullYear() - hire.getFullYear();
            return years > 0 ? years : 1;
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            
            document.querySelectorAll('.sidebar-menu a').forEach(item => {
                item.classList.remove('active');
            });
            
            // Mark the active menu item
            const activeMenuItem = document.querySelector(`.sidebar-menu a[href="#${sectionId}"]`);
            if (activeMenuItem) {
                activeMenuItem.classList.add('active');
            }
            
            document.getElementById(sectionId).style.display = 'block';
        }

        function showAddGuardForm() {
            if (!hasPermission('create', 'guards')) {
                alert('شما دسترسی لازم برای افزودن محافظ را ندارید');
                return;
            }
            document.getElementById('addGuardForm').style.display = 'block';
        }

        function hideAddGuardForm() {
            document.getElementById('addGuardForm').style.display = 'none';
            document.getElementById('guardForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
        }

        // ==================== GUARD PROFILE SYSTEM ====================
        function loadGuardProfile() {
            const container = document.getElementById('guardProfileDetails');
            
            // پیدا کردن اطلاعات محافظ جاری
            const currentGuard = guards.find(guard => 
                guard.phoneNumber === currentUser.phone
            );

            if (!currentGuard) {
                container.innerHTML = '<div class="alert alert-warning">اطلاعات پروفایل یافت نشد</div>';
                return;
            }

            const positionText = getPositionText(currentGuard.position);
            const serviceYears = calculateServiceYears(currentGuard.hireDate);
            const categoryText = getGuardCategoryText(currentGuard.guardCategory);

            container.innerHTML = `
                <div class="row">
                    <div class="col-md-4 text-center">
                        ${currentGuard.photoData ? 
                            `<img src="${currentGuard.photoData}" class="profile-photo-large" alt="${currentGuard.firstName} ${currentGuard.lastName}">` :
                            `<div class="profile-photo-placeholder">
                                <i class="fas fa-user"></i>
                            </div>`
                        }
                        <h4 class="mt-3">${currentGuard.firstName} ${currentGuard.lastName}</h4>
                        <span class="badge bg-primary fs-6">${positionText}</span>
                        <span class="badge ${currentGuard.guardCategory === 'mobile' ? 'bg-success' : 'bg-primary'} mt-1">${categoryText}</span>
                    </div>
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2">مشخصات شخصی</h5>
                            </div>
                            <div class="col-md-6">
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">نام کامل:</span>
                                    ${currentGuard.firstName} ${currentGuard.lastName}
                                </div>
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">نام پدر:</span>
                                    ${currentGuard.fatherName}
                                </div>
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">شماره تماس:</span>
                                    ${currentGuard.phoneNumber}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">کشور:</span>
                                    ${currentGuard.country || 'ثبت نشده'}
                                </div>
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">ولایت:</span>
                                    ${currentGuard.province || 'ثبت نشده'}
                                </div>
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">ولسوالی:</span>
                                    ${currentGuard.district || 'ثبت نشده'}
                                </div>
                            </div>
                            
                            <div class="col-12 mt-3">
                                <h5 class="border-bottom pb-2">مشخصات کاری</h5>
                            </div>
                            <div class="col-md-6">
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">تاریخ استخدام:</span>
                                    ${currentGuard.hireDate}
                                </div>
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">مدت خدمت:</span>
                                    ${serviceYears} سال
                                </div>
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">دسته:</span>
                                    ${categoryText}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">نقش:</span>
                                    <span class="badge ${currentGuard.role === 'manager' ? 'bg-warning' : 'bg-info'}">
                                        ${getRoleText(currentGuard.role)}
                                    </span>
                                </div>
                                <div class="profile-detail-item">
                                    <span class="profile-detail-label">وضعیت:</span>
                                    <span class="badge bg-success">فعال</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // FIXED: Edit my profile function
        function editMyProfile() {
            // پیدا کردن اطلاعات محافظ جاری
            const currentGuard = guards.find(guard => 
                guard.phoneNumber === currentUser.phone
            );

            if (currentGuard) {
                currentEditingGuardId = currentGuard.id;
                editGuard(currentGuard.id);
            }
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            createDefaultAdmin();
            
            // Set today's date for forms
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('hireDate').value = today;
            document.getElementById('shiftDate').value = today;
        });
    </script>
</body>
</html>
